(function(){"use strict";let o;const S=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&S.decode();let g=null;function p(){return(g===null||g.byteLength===0)&&(g=new Uint8Array(o.memory.buffer)),g}function y(e,t){return e=e>>>0,S.decode(p().subarray(e,e+t))}const l=new Array(128).fill(void 0);l.push(void 0,null,!0,!1);let h=l.length;function w(e){h===l.length&&l.push(l.length+1);const t=h;return h=l[t],l[t]=e,t}function m(e){return l[e]}function L(e){e<132||(l[e]=h,h=e)}function v(e){const t=m(e);return L(e),t}let A=null;function c(){return(A===null||A.byteLength===0)&&(A=new Int32Array(o.memory.buffer)),A}let d=0;const E=typeof TextEncoder<"u"?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},M=typeof E.encodeInto=="function"?function(e,t){return E.encodeInto(e,t)}:function(e,t){const n=E.encode(e);return t.set(n),{read:e.length,written:n.length}};function T(e,t,n){if(n===void 0){const _=E.encode(e),b=t(_.length,1)>>>0;return p().subarray(b,b+_.length).set(_),d=_.length,b}let r=e.length,a=t(r,1)>>>0;const i=p();let s=0;for(;s<r;s++){const _=e.charCodeAt(s);if(_>127)break;i[a+s]=_}if(s!==r){s!==0&&(e=e.slice(s)),a=n(a,r,r=s+e.length*3,1)>>>0;const _=p().subarray(a+s,a+r),b=M(e,_);s+=b.written}return d=s,a}function I(){try{const n=o.__wbindgen_add_to_stack_pointer(-16);o.init_rs(n);var e=c()[n/4+0],t=c()[n/4+1];if(t)throw v(e)}finally{o.__wbindgen_add_to_stack_pointer(16)}}function R(e,t){const n=t(e.length*1,1)>>>0;return p().set(e,n/1),d=e.length,n}function C(e){try{const a=o.__wbindgen_add_to_stack_pointer(-16),i=R(e,o.__wbindgen_malloc),s=d;o.load_epub(a,i,s);var t=c()[a/4+0],n=c()[a/4+1],r=c()[a/4+2];if(r)throw v(n);return W.__wrap(t)}finally{o.__wbindgen_add_to_stack_pointer(16)}}function O(e){let t,n;try{const i=o.__wbindgen_add_to_stack_pointer(-16),s=T(e,o.__wbindgen_malloc,o.__wbindgen_realloc),_=d;o.guess_mime_type(i,s,_);var r=c()[i/4+0],a=c()[i/4+1];return t=r,n=a,y(r,a)}finally{o.__wbindgen_add_to_stack_pointer(16),o.__wbindgen_free(t,n,1)}}class W{static __wrap(t){t=t>>>0;const n=Object.create(W.prototype);return n.__wbg_ptr=t,n}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,t}free(){const t=this.__destroy_into_raw();o.__wbg_epubctxt_free(t)}metadata(){let t,n;try{const i=o.__wbindgen_add_to_stack_pointer(-16);o.epubctxt_metadata(i,this.__wbg_ptr);var r=c()[i/4+0],a=c()[i/4+1];return t=r,n=a,y(r,a)}finally{o.__wbindgen_add_to_stack_pointer(16),o.__wbindgen_free(t,n,1)}}read_file(t){try{const i=o.__wbindgen_add_to_stack_pointer(-16),s=T(t,o.__wbindgen_malloc,o.__wbindgen_realloc),_=d;o.epubctxt_read_file(i,this.__wbg_ptr,s,_);var n=c()[i/4+0],r=c()[i/4+1],a=c()[i/4+2];if(a)throw v(r);return v(n)}finally{o.__wbindgen_add_to_stack_pointer(16)}}}async function j(e,t){if(typeof Response=="function"&&e instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(e,t)}catch(r){if(e.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r);else throw r}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}else{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}function q(){const e={};return e.wbg={},e.wbg.__wbindgen_error_new=function(t,n){const r=new Error(y(t,n));return w(r)},e.wbg.__wbindgen_object_drop_ref=function(t){v(t)},e.wbg.__wbg_new_abda76e883ba8a5f=function(){const t=new Error;return w(t)},e.wbg.__wbg_stack_658279fe44541cf6=function(t,n){const r=m(n).stack,a=T(r,o.__wbindgen_malloc,o.__wbindgen_realloc),i=d;c()[t/4+1]=i,c()[t/4+0]=a},e.wbg.__wbg_error_f851667af71bcfc6=function(t,n){let r,a;try{r=t,a=n,console.error(y(t,n))}finally{o.__wbindgen_free(r,a,1)}},e.wbg.__wbg_buffer_a448f833075b71ba=function(t){const n=m(t).buffer;return w(n)},e.wbg.__wbg_newwithbyteoffsetandlength_d0482f893617af71=function(t,n,r){const a=new Uint8Array(m(t),n>>>0,r>>>0);return w(a)},e.wbg.__wbg_new_8f67e318f15d7254=function(t){const n=new Uint8Array(m(t));return w(n)},e.wbg.__wbindgen_throw=function(t,n){throw new Error(y(t,n))},e.wbg.__wbindgen_memory=function(){const t=o.memory;return w(t)},e}function B(e,t){return o=e.exports,U.__wbindgen_wasm_module=t,A=null,g=null,o}async function U(e){if(o!==void 0)return o;typeof e>"u"&&(e=new URL(""+new URL("assets/rs_utils_bg-pSUBSkd2.wasm",self.location.href).href,self.location.href));const t=q();(typeof e=="string"||typeof Request=="function"&&e instanceof Request||typeof URL=="function"&&e instanceof URL)&&(e=fetch(e));const{instance:n,module:r}=await j(await e,t);return B(n,r)}let f=self,k,x,D=new BroadcastChannel("install-channel"),P=new BroadcastChannel("log-channel"),u=(...e)=>P.postMessage(e.map(t=>t.toString()).join("	"));f.addEventListener("install",async e=>{u("Installed"),await Promise.all([f.skipWaiting(),U()]),I(),u("Initialized"),D.postMessage("installed")}),f.addEventListener("activate",async e=>{u("Activated"),await f.clients.claim(),u("Claimed")}),f.addEventListener("fetch",e=>{if(!k||!x)return;let n=x+"bene-reader/epub-content/";if(e.request.url.startsWith(n)){let r=e.request.url.slice(n.length);r=r.split("#")[0];let a=k.read_file(r),i=O(r);e.respondWith(new Response(a,{status:200,headers:{"Content-Type":i}})),u("Handling request for",e.request.url,"with guessed type",i)}else u("Ignoring request for",e.request.url)}),f.addEventListener("message",async e=>{let t=e.data;if(t.type=="new-epub"){let{data:n,scope:r,url:a,path:i}=t.data;k=C(n),x=r;let s=JSON.parse(k.metadata()),_=await f.clients.matchAll();u("Loaded new epub, broadcasting to window");for(let b of _)b.postMessage({type:"loaded-epub",data:{metadata:s,url:a,path:i}})}})})();
