/*
 * Copyright (c) 2014 cannon.js Authors
 *
 * Permission is hereby granted, free of charge, to any person
 * obtaining a copy of this software and associated documentation
 * files (the "Software"), to deal in the Software without
 * restriction, including without limitation the rights to use, copy,
 * modify, merge, publish, distribute, sublicense, and/or sell copies
 * of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */

!function(e){if("object"==typeof exports)module.exports=e();else if("function"==typeof define&&define.amd)define(e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.CANNON=e()}}(function(){return function e(f,n,o){function d(t,l){if(!n[t]){if(!f[t]){var u="function"==typeof require&&require;if(!l&&u)return u(t,!0);if(i)return i(t,!0);throw new Error("Cannot find module '"+t+"'")}var p=n[t]={exports:{}};f[t][0].call(p.exports,function(e){var n=f[t][1][e];return d(n?n:e)},p,p.exports,e,f,n,o)}return n[t].exports}for(var i="function"==typeof require&&require,t=0;t<o.length;t++)d(o[t]);return d}({1:[function(e,f){f.exports={name:"cannon",version:"0.6.0",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/schteppe/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",keywords:["cannon.js","cannon","physics","engine","3d"],main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/schteppe/cannon.js.git"},bugs:{url:"https://github.com/schteppe/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"latest",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"~0.1.2","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"*","grunt-browserify":"*","grunt-contrib-yuidoc":"*",browserify:"*"},dependencies:{}}},{}],2:[function(e,f){f.exports={version:e("../package.json").version,ArrayCollisionMatrix:e("./collision/ArrayCollisionMatrix"),Body:e("./objects/Body"),Box:e("./shapes/Box"),Broadphase:e("./collision/Broadphase"),Compound:e("./shapes/Compound"),Constraint:e("./constraints/Constraint"),ContactEquation:e("./equations/ContactEquation"),ContactGenerator:e("./world/ContactGenerator"),ContactMaterial:e("./material/ContactMaterial"),ConvexPolyhedron:e("./shapes/ConvexPolyhedron"),Cylinder:e("./shapes/Cylinder"),DistanceConstraint:e("./constraints/DistanceConstraint"),Equation:e("./equations/Equation"),EventTarget:e("./utils/EventTarget"),FrictionEquation:e("./equations/FrictionEquation"),GSSolver:e("./solver/GSSolver"),GridBroadphase:e("./collision/GridBroadphase"),HingeConstraint:e("./constraints/HingeConstraint"),Mat3:e("./math/Mat3"),Material:e("./material/Material"),NaiveBroadphase:e("./collision/NaiveBroadphase"),ObjectCollisionMatrix:e("./collision/ObjectCollisionMatrix"),Pool:e("./utils/Pool"),Particle:e("./objects/Particle"),Plane:e("./shapes/Plane"),PointToPointConstraint:e("./constraints/PointToPointConstraint"),Quaternion:e("./math/Quaternion"),Ray:e("./collision/Ray"),RigidBody:e("./objects/RigidBody"),RotationalEquation:e("./equations/RotationalEquation"),RotationalMotorEquation:e("./equations/RotationalMotorEquation"),SAP1DBroadphase:e("./collision/SAP1DBroadphase"),SPHSystem:e("./objects/SPHSystem"),Shape:e("./shapes/Shape"),Solver:e("./solver/Solver"),Sphere:e("./shapes/Sphere"),SplitSolver:e("./solver/SplitSolver"),Vec3:e("./math/Vec3"),Vec3Pool:e("./utils/Vec3Pool"),World:e("./world/World")}},{"../package.json":1,"./collision/ArrayCollisionMatrix":3,"./collision/Broadphase":4,"./collision/GridBroadphase":5,"./collision/NaiveBroadphase":6,"./collision/ObjectCollisionMatrix":7,"./collision/Ray":8,"./collision/SAP1DBroadphase":9,"./constraints/Constraint":10,"./constraints/DistanceConstraint":11,"./constraints/HingeConstraint":12,"./constraints/PointToPointConstraint":13,"./equations/ContactEquation":14,"./equations/Equation":15,"./equations/FrictionEquation":16,"./equations/RotationalEquation":17,"./equations/RotationalMotorEquation":18,"./material/ContactMaterial":19,"./material/Material":20,"./math/Mat3":21,"./math/Quaternion":22,"./math/Vec3":23,"./objects/Body":24,"./objects/Particle":25,"./objects/RigidBody":26,"./objects/SPHSystem":27,"./shapes/Box":28,"./shapes/Compound":29,"./shapes/ConvexPolyhedron":30,"./shapes/Cylinder":31,"./shapes/Plane":32,"./shapes/Shape":33,"./shapes/Sphere":34,"./solver/GSSolver":35,"./solver/Solver":36,"./solver/SplitSolver":37,"./utils/EventTarget":38,"./utils/Pool":39,"./utils/Vec3Pool":40,"./world/ContactGenerator":41,"./world/World":42}],3:[function(e,f){function n(){this.matrix=[]}f.exports=n,n.prototype.get=function(e,f){if(e=e.index,f=f.index,f>e){var n=f;f=e,e=n}return this.matrix[(e*(e+1)>>1)+f-1]},n.prototype.set=function(e,f,n){if(e=e.index,f=f.index,f>e){var o=f;f=e,e=o}this.matrix[(e*(e+1)>>1)+f-1]=n?1:0},n.prototype.reset=function(){for(var e=0,f=this.matrix.length;e!==f;e++)this.matrix[e]=0},n.prototype.setNumObjects=function(e){this.matrix.length=e*(e-1)>>1}},{}],4:[function(e,f){function n(){this.world=null,this.useBoundingBoxes=!1}var o=e("../objects/Body"),d=e("../math/Vec3"),i=e("../math/Quaternion"),t=e("../shapes/Shape"),l=e("../shapes/Plane");f.exports=n,n.prototype.collisionPairs=function(){throw new Error("collisionPairs not implemented for this BroadPhase class!")};var u=o.STATIC|o.KINEMATIC;n.prototype.needBroadphaseCollision=function(e,f){return 0===(e.collisionFilterGroup&f.collisionFilterMask)||0===(f.collisionFilterGroup&e.collisionFilterMask)?!1:0===(e.motionstate&u)&&!e.isSleeping()||0===(f.motionstate&u)&&!f.isSleeping()?e.shape||f.shape?e.shape instanceof l&&f.shape instanceof l?!1:!0:!1:!1},n.prototype.intersectionTest=function(e,f,n,o){this.useBoundingBoxes?this.doBoundingBoxBroadphase(e,f,n,o):this.doBoundingSphereBroadphase(e,f,n,o)};var p=new d,s=new d,c=(new i,new d);n.prototype.doBoundingSphereBroadphase=function(e,f,n,d){var i=t.types,l=i.SPHERE|i.BOX|i.COMPOUND|i.CONVEXPOLYHEDRON,u=i.PLANE,y=(o.STATIC|o.KINEMATIC,p),a=s,r=c,w=e.shape,b=f.shape;if(w&&b){var N=w.type,g=b.type;if(N&l&&g&l){f.position.vsub(e.position,y),w.boundingSphereRadiusNeedsUpdate&&w.computeBoundingSphereRadius(),b.boundingSphereRadiusNeedsUpdate&&b.computeBoundingSphereRadius();var m=w.boundingSphereRadius+b.boundingSphereRadius;y.norm2()<m*m&&(n.push(e),d.push(f))}else if(N&l&&g&i.PLANE||g&l&&N&i.PLANE){var x=N===u?e:f,j=N!==u?e:f,v=j.shape,A=x.shape;j.position.vsub(x.position,y),A.worldNormalNeedsUpdate&&A.computeWorldNormal(x.quaternion),a=A.worldNormal,v.boundingSphereRadiusNeedsUpdate&&v.computeBoundingSphereRadius();var C=y.dot(a)-v.boundingSphereRadius;0>C&&(n.push(e),d.push(f))}}else if(w||b){var O=w?f:e,h=w?e:f,v=h.shape,k=v.type;if(k&l){if(k===i.SPHERE)O.position.vsub(h.position,r),v.radius*v.radius>=r.norm2()&&(n.push(O),d.push(h));else if(k===i.CONVEXPOLYHEDRON||k===i.BOX||k===i.COMPOUND){v.boundingSphereRadiusNeedsUpdate&&v.computeBoundingSphereRadius();var q=v.boundingSphereRadius;O.position.vsub(h.position,r),q*q>=r.norm2()&&(n.push(O),d.push(h))}}else if(k===i.PLANE){var z=h;a.set(0,0,1),z.quaternion.vmult(a,a),O.position.vsub(z.position,r),a.dot(r)<=0&&(n.push(O),d.push(h))}}else;},n.prototype.doBoundingBoxBroadphase=function(e,f,n,o){var d=e.shape,i=f.shape;if(e.aabbNeedsUpdate&&e.computeAABB(),f.aabbNeedsUpdate&&f.computeAABB(),d&&i)e.aabbmax.x<f.aabbmin.x||e.aabbmax.y<f.aabbmin.y||e.aabbmax.z<f.aabbmin.z||e.aabbmin.x>f.aabbmax.x||e.aabbmin.y>f.aabbmax.y||e.aabbmin.z>f.aabbmax.z||(n.push(e),o.push(f));else if(d||i){var t=d?f:e,u=d?e:f;u.shape instanceof l,t.position.x<u.aabbmin.x||t.position.y<u.aabbmin.y||t.position.z<u.aabbmin.z||t.position.x>u.aabbmax.x||t.position.y>u.aabbmax.y||t.position.z>u.aabbmax.z||(n.push(e),o.push(f))}else;};var y={keys:[]},a=[],r=[];n.prototype.makePairsUnique=function(e,f){for(var n=y,o=a,d=r,i=e.length,t=0;t!==i;t++)o[t]=e[t],d[t]=f[t];e.length=0,f.length=0;for(var t=0;t!==i;t++){var l=o[t].id,u=d[t].id,p=u>l?l+","+u:u+","+l;n[p]=t,n.keys.push(p)}for(var t=0;t!==n.keys.length;t++){var p=n.keys.pop(),s=n[p];e.push(o[s]),f.push(d[s]),delete n[p]}},n.prototype.setWorld=function(){};var w=new d;n.boundingSphereCheck=function(e,f){var n=w;return e.position.vsub(f.position,n),Math.pow(e.shape.boundingSphereRadius+f.shape.boundingSphereRadius,2)>n.norm2()}},{"../math/Quaternion":22,"../math/Vec3":23,"../objects/Body":24,"../shapes/Plane":32,"../shapes/Shape":33}],5:[function(e,f){function n(e,f,n,i,t){o.apply(this),this.nx=n||10,this.ny=i||10,this.nz=t||10,this.aabbMin=e||new d(100,100,100),this.aabbMax=f||new d(-100,-100,-100);var l=this.nx*this.ny*this.nz;if(0>=l)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=l,this.binLengths.length=l;for(var u=0;l>u;u++)this.bins[u]=[],this.binLengths[u]=0}f.exports=n;var o=e("./Broadphase"),d=e("../math/Vec3"),i=e("../shapes/Shape");n.prototype=new o,n.prototype.constructor=n;{var t=new d;new d}n.prototype.collisionPairs=function(e,f,n){function o(e,f,n,o,d,i,t){var l=(e-m)*v|0,u=(f-x)*A|0,p=(n-j)*C|0,b=I((o-m)*v),N=I((d-x)*A),g=I((i-j)*C);0>l?l=0:l>=s&&(l=s-1),0>u?u=0:u>=c&&(u=c-1),0>p?p=0:p>=y&&(p=y-1),0>b?b=0:b>=s&&(b=s-1),0>N?N=0:N>=c&&(N=c-1),0>g?g=0:g>=y&&(g=y-1),l*=a,u*=r,p*=w,b*=a,N*=r,g*=w;for(var O=l;b>=O;O+=a)for(var h=u;N>=h;h+=r)for(var k=p;g>=k;k+=w){var q=O+h+k;E[q][F[q]++]=t}}for(var d=e.numObjects(),l=e.bodies,u=this.aabbMax,p=this.aabbMin,s=this.nx,c=this.ny,y=this.nz,a=c*y,r=y,w=1,b=u.x,N=u.y,g=u.z,m=p.x,x=p.y,j=p.z,v=s/(b-m),A=c/(N-x),C=y/(g-j),O=(b-m)/s,h=(N-x)/c,k=(g-j)/y,q=.5*Math.sqrt(O*O+h*h+k*k),z=i.types,B=z.SPHERE,D=z.PLANE,E=(z.BOX,z.COMPOUND,z.CONVEXPOLYHEDRON,this.bins),F=this.binLengths,G=this.bins.length,H=0;H!==G;H++)F[H]=0;for(var I=Math.ceil,p=Math.min,u=Math.max,H=0;H!==d;H++){var J=l[H],K=J.shape;switch(K.type){case B:var L=J.position.x,M=J.position.y,P=J.position.z,Q=K.radius;o(L-Q,M-Q,P-Q,L+Q,M+Q,P+Q,J);break;case D:K.worldNormalNeedsUpdate&&K.computeWorldNormal(J.quaternion);var R=K.worldNormal,S=m+.5*O-J.position.x,T=x+.5*h-J.position.y,U=j+.5*k-J.position.z,V=t;V.set(S,T,U);for(var W=0,X=0;W!==s;W++,X+=a,V.y=T,V.x+=O)for(var Y=0,Z=0;Y!==c;Y++,Z+=r,V.z=U,V.y+=h)for(var $=0,_=0;$!==y;$++,_+=w,V.z+=k)if(V.dot(R)<q){var ef=X+Z+_;E[ef][F[ef]++]=J}break;default:J.aabbNeedsUpdate&&J.computeAABB(),o(J.aabbmin.x,J.aabbmin.y,J.aabbmin.z,J.aabbmax.x,J.aabbmax.y,J.aabbmax.z,J)}}for(var H=0;H!==G;H++){var ff=F[H];if(ff>1)for(var nf=E[H],W=0;W!==ff;W++)for(var J=nf[W],Y=0;Y!==W;Y++){var of=nf[Y];this.needBroadphaseCollision(J,of)&&this.intersectionTest(J,of,f,n)}}this.makePairsUnique(f,n)}},{"../math/Vec3":23,"../shapes/Shape":33,"./Broadphase":4}],6:[function(e,f){function n(){o.apply(this)}f.exports=n;var o=e("./Broadphase");n.prototype=new o,n.prototype.constructor=n,n.prototype.collisionPairs=function(e,f,n){var o,d,i,t,l=e.bodies,u=l.length;for(o=0;o!==u;o++)for(d=0;d!==o;d++)i=l[o],t=l[d],this.needBroadphaseCollision(i,t)&&this.intersectionTest(i,t,f,n)}},{"./Broadphase":4}],7:[function(e,f){function n(){this.matrix={}}f.exports=n,n.prototype.get=function(e,f){if(e=e.id,f=f.id,f>e){var n=f;f=e,e=n}return e+"-"+f in this.matrix},n.prototype.set=function(e,f,n){if(e=e.id,f=f.id,f>e){var o=f;f=e,e=o}n?this.matrix[e+"-"+f]=!0:delete this.matrix[e+"-"+f]},n.prototype.reset=function(){this.matrix={}},n.prototype.setNumObjects=function(){}},{}],8:[function(e,f){function n(e,f){this.origin=e||new t,this.direction=f||new t,this.precision=1e-4}function o(e,f,n,o){o.vsub(f,N),n.vsub(f,p),e.vsub(f,s);var d,i,t=N.dot(N),l=N.dot(p),u=N.dot(s),c=p.dot(p),y=p.dot(s);return(d=c*u-l*y)>=0&&(i=t*y-l*u)>=0&&t*c-l*l>d+i}function d(e,f){return e.distance-f.distance}function i(e,f,n){n.vsub(e,N);var o=N.dot(f);f.mult(o,g),g.vadd(e,g);var d=n.distanceTo(g);return d}f.exports=n;var t=e("../math/Vec3"),l=e("../shapes/ConvexPolyhedron"),u=e("../shapes/Box");n.prototype.constructor=n;var p=new t,s=new t;n.prototype.intersectBody=function(e){return e.shape instanceof l?this.intersectShape(e.shape,e.quaternion,e.position,e):e.shape instanceof u?this.intersectShape(e.shape.convexPolyhedronRepresentation,e.quaternion,e.position,e):void console.warn("Ray intersection is this far only implemented for ConvexPolyhedron and Box shapes.")},n.prototype.intersectBodies=function(e){for(var f=[],n=0,o=e.length;o>n;n++){var i=this.intersectBody(e[n]);Array.prototype.push.apply(f,i)}return f.sort(d),f};{var c=new t,y=new t,a=new t,r=new t,w=new t,b=new t;new t,new t}n.prototype.intersectShape=function(e,f,n,d){var t,u=[];if(e instanceof l){var p=i(this.origin,this.direction,n);if(p>e.getBoundingSphereRadius())return u;for(var s,N,g=e.faces,m=e.vertices,x=e.faceNormals,j=0;j<g.length;j++){var v=g[j],A=x[j],C=f,O=n;if(m[v[0]].copy(c),C.vmult(c,c),c.vadd(O,c),c.vsub(this.origin,c),C.vmult(A,y),s=this.direction.dot(y),!(Math.abs(s)<this.precision)&&(N=y.dot(c)/s,!(0>N)&&0>s)){this.direction.mult(N,a),a.vadd(this.origin,a),m[v[0]].copy(r),C.vmult(r,r),O.vadd(r,r);for(var h=1;h<v.length-1;h++)if(m[v[h]].copy(w),m[v[h+1]].copy(b),C.vmult(w,w),C.vmult(b,b),O.vadd(w,w),O.vadd(b,b),o(a,r,w,b)){t={distance:this.origin.distanceTo(a),point:a.copy(),face:v,body:d},u.push(t);break}}}}return u};var N=new t,g=new t},{"../math/Vec3":23,"../shapes/Box":28,"../shapes/ConvexPolyhedron":30}],9:[function(e,f){function n(e){o.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var f=this.axisList;this._addBodyHandler=function(e){f.push(e.body)},this._removeBodyHandler=function(e){var n=f.indexOf(e.body);-1!==n&&f.splice(n,1)},e&&this.setWorld(e)}var o=(e("../shapes/Shape"),e("../collision/Broadphase"));f.exports=n,n.prototype=new o,n.prototype.setWorld=function(e){this.axisList.length=0;for(var f=0;f<e.bodies.length;f++)this.axisList.push(e.bodies[f]);e.removeEventListener("addBody",this._addBodyHandler),e.removeEventListener("removeBody",this._removeBodyHandler),e.addEventListener("addBody",this._addBodyHandler),e.addEventListener("removeBody",this._removeBodyHandler),this.world=e},n.sortAxisListX=function(e,f){return e.position.x-e.shape.boundingSphereRadius-(f.position.x-f.shape.boundingSphereRadius)},n.sortAxisListY=function(e,f){return e.position.y-e.shape.boundingSphereRadius-(f.position.y-f.shape.boundingSphereRadius)},n.sortAxisListZ=function(e,f){return e.position.z-e.shape.boundingSphereRadius-(f.position.z-f.shape.boundingSphereRadius)},n.prototype.collisionPairs=function(e,f,o){var d,i,t,l=this.axisList,u=this.axisIndex;for(0===u?t=n.sortAxisListX:1===u?t=n.sortAxisListY:2===u&&(t=n.sortAxisListZ),l.sort(t),d=0,N=l.length;d!==N;d++){var p=l[d];for(i=d+1;N>i;i++){var s=l[i];if(!n.checkBounds(p,s,u))break;this.doBoundingSphereBroadphase(p,s,f,o)}}},n.checkBounds=function(e,f,n){var o;0==n&&(o="x"),1==n&&(o="y"),2==n&&(o="z");var d=e.position[o],i=e.shape.boundingSphereRadius,t=f.position[o],l=f.shape.boundingSphereRadius,u=d+i,p=t-l;return u>p}},{"../collision/Broadphase":4,"../shapes/Shape":33}],10:[function(e,f){function n(e,f){this.equations=[],this.bodyA=e,this.bodyB=f}f.exports=n,n.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")}},{}],11:[function(e,f){function n(e,f,n,i){o.call(this,e,f),"undefined"==typeof i&&(i=1e6);var t=this.equations=[new d(e,f)],l=t[0];l.minForce=-i,l.maxForce=i,this.update=function(){f.position.vsub(e.position,l.ni),l.ni.normalize(),l.ni.mult(.5*n,l.ri),l.ni.mult(.5*-n,l.rj)}}f.exports=n;var o=e("./Constraint"),d=e("../equations/ContactEquation");n.prototype=new o},{"../equations/ContactEquation":14,"./Constraint":10}],12:[function(e,f){function n(e,f,n,u,p,s,c){o.call(this,e,u),c=c||1e6;var y=this,a=this.equations=[new d(e,u),new d(e,u),new t(e,u),new t(e,u),new t(e,u)];this.getRotationalEquation1=function(){return a[0]},this.getRotationalEquation2=function(){return a[1]},this.getPointToPointEquation1=function(){return a[2]},this.getPointToPointEquation2=function(){return a[3]},this.getPointToPointEquation3=function(){return a[4]};var r,w=this.getRotationalEquation1(),b=this.getRotationalEquation2(),N=this.getPointToPointEquation1(),g=this.getPointToPointEquation2(),m=this.getPointToPointEquation3();g.minForce=m.minForce=N.minForce=-c,g.maxForce=m.maxForce=N.maxForce=c;var x=f.unit(),j=p.unit(),v=new l,A=new l,C=new l;n.cross(x,v),v.norm2()<.001&&x.tangents(v,v),n.cross(v,A),s.cross(j,C),C.norm2()<.001&&s.tangents(C,C),v.normalize(),C.normalize();var O=!1;this.motorTargetVelocity=0,this.motorMinForce=-c,this.motorMaxForce=c,this.enableMotor=function(){O||(r=new i(e,u,c),a.push(r),O=!0)},this.disableMotor=function(){O&&(O=!1,r=null,a.pop())},this.update=function(){N.ni.set(1,0,0),g.ni.set(0,1,0),m.ni.set(0,0,1),e.quaternion.vmult(f,N.ri),u.quaternion.vmult(p,N.rj),N.ri.copy(g.ri),N.rj.copy(g.rj),N.ri.copy(m.ri),N.rj.copy(m.rj),e.quaternion.vmult(v,w.ni),u.quaternion.vmult(s,w.nj),e.quaternion.vmult(A,b.ni),u.quaternion.vmult(s,b.nj),O&&(e.quaternion.vmult(n,r.axisA),u.quaternion.vmult(s,r.axisB),r.targetVelocity=y.motorTargetVelocity,r.maxForce=y.motorMaxForce,r.minForce=y.motorMinForce)}}f.exports=n;var o=e("./Constraint"),d=e("../equations/RotationalEquation"),i=e("../equations/RotationalMotorEquation"),t=e("../equations/ContactEquation"),l=e("../math/Vec3");n.prototype=new o},{"../equations/ContactEquation":14,"../equations/RotationalEquation":17,"../equations/RotationalMotorEquation":18,"../math/Vec3":23,"./Constraint":10}],13:[function(e,f){function n(e,f,n,i,t){o.call(this,e,n);var l=this.equations=[new d(e,n),new d(e,n),new d(e,n)],u=l[0],p=l[1],s=l[2];p.minForce=s.minForce=u.minForce=-t,p.maxForce=s.maxForce=u.maxForce=t,this.update=function(){n.position.vsub(e.position,u.ni),u.ni.normalize(),e.quaternion.vmult(f,u.ri),n.quaternion.vmult(i,u.rj),u.ni.tangents(p.ni,s.ni),u.ri.copy(p.ri),u.rj.copy(p.rj),u.ri.copy(s.ri),u.rj.copy(s.rj)}}f.exports=n;var o=e("./Constraint"),d=e("../equations/ContactEquation");n.prototype=new o},{"../equations/ContactEquation":14,"./Constraint":10}],14:[function(e,f){function n(e,f){o.call(this,e,f,0,1e6),this.restitution=0,this.ri=new d,this.rj=new d,this.penetrationVec=new d,this.ni=new d,this.rixn=new d,this.rjxn=new d,this.invIi=new i,this.invIj=new i,this.biInvInertiaTimesRixn=new d,this.bjInvInertiaTimesRjxn=new d}f.exports=n;var o=e("./Equation"),d=e("../math/Vec3"),i=e("../math/Mat3");n.prototype=new o,n.prototype.constructor=n,n.prototype.reset=function(){this.invInertiaWorldTimesRxnNeedsUpdate=!0};var t=new d,l=new d,u=new d;n.prototype.computeB=function(e){var f=this.a,n=this.b,o=this.bi,d=this.bj,i=this.ri,p=this.rj,s=this.rixn,c=this.rjxn,y=u,a=o.velocity,r=o.angularVelocity?o.angularVelocity:y,w=o.force,b=o.tau?o.tau:y,N=d.velocity,g=d.angularVelocity?d.angularVelocity:y,m=d.force,x=d.tau?d.tau:y,j=this.penetrationVec,v=o.invMass,A=d.invMass,C=(this.invIi,this.invIj,this.ni);i.cross(C,s),p.cross(C,c);var j=this.penetrationVec;j.set(0,0,0),j.vadd(d.position,j),j.vadd(p,j),j.vsub(o.position,j),j.vsub(i,j);var O=C.dot(j),h=t,k=l;o.invInertiaWorld&&o.invInertiaWorld.vmult(b,h),d.invInertiaWorld&&d.invInertiaWorld.vmult(x,k);var q=this.restitution+1,z=q*N.dot(C)-q*a.dot(C)+g.dot(c)-r.dot(s),B=m.dot(C)*A-w.dot(C)*v+c.dot(k)-s.dot(h),D=-O*f-z*n-e*B;return D};new d,new d;n.prototype.computeC=function(){{var e=this.bi,f=this.bj,n=this.rixn,o=this.rjxn,d=e.invMass,i=f.invMass,t=d+i+this.eps;this.invIi,this.invIj}return e.invInertiaWorld&&e.invInertiaWorld.vmult(n,this.biInvInertiaTimesRixn),f.invInertiaWorld&&f.invInertiaWorld.vmult(o,this.bjInvInertiaTimesRjxn),t+=this.biInvInertiaTimesRixn.dot(n),t+=this.bjInvInertiaTimesRjxn.dot(o)};var p=new d;n.prototype.computeGWlambda=function(){var e=this.bi,f=this.bj,n=p,o=0;return f.vlambda.vsub(e.vlambda,n),o+=n.dot(this.ni),e.wlambda&&(o-=e.wlambda.dot(this.rixn)),f.wlambda&&(o+=f.wlambda.dot(this.rjxn)),o};var s=new d,c=new d;n.prototype.addToWlambda=function(e){var f=this.bi,n=this.bj,o=(this.rixn,this.rjxn,f.invMass),d=n.invMass,i=this.ni,t=s,l=c;i.mult(o*e,l),f.vlambda.vsub(l,f.vlambda),i.mult(d*e,l),n.vlambda.vadd(l,n.vlambda),void 0!==f.wlambda&&(this.biInvInertiaTimesRixn.mult(e,t),f.wlambda.vsub(t,f.wlambda)),void 0!==n.wlambda&&(this.bjInvInertiaTimesRjxn.mult(e,t),n.wlambda.vadd(t,n.wlambda))}},{"../math/Mat3":21,"../math/Vec3":23,"./Equation":15}],15:[function(e,f){function n(e,f,n,o){this.id=-1,this.minForce="undefined"==typeof n?-1e6:n,this.maxForce="undefined"==typeof o?1e6:o,this.bi=e,this.bj=f,this.stiffness=1e7,this.regularizationTime=5,this.a=0,this.b=0,this.eps=0,this.spookParamsNeedsUpdate=!0}f.exports=n,n.prototype.constructor=n,n.prototype.updateSpookParams=function(e){var f=this.regularizationTime,n=this.stiffness;this.a=4/(e*(1+4*f)),this.b=4*f/(1+4*f),this.eps=4/(e*e*n*(1+4*f))}},{}],16:[function(e,f){function n(e,f,n){o.call(this,e,f,-n,n),this.ri=new d,this.rj=new d,this.t=new d,this.rixt=new d,this.rjxt=new d,this.wixri=new d,this.wjxrj=new d,this.invIi=new i,this.invIj=new i,this.relVel=new d,this.relForce=new d,this.biInvInertiaTimesRixt=new d,this.bjInvInertiaTimesRjxt=new d}f.exports=n;var o=e("./Equation"),d=e("../math/Vec3"),i=e("../math/Mat3");n.prototype=new o,n.prototype.constructor=n;var t=new d,l=new d,u=new d;n.prototype.computeB=function(e){var f=this.a,n=this.b,o=this.bi,d=this.bj,i=this.ri,p=this.rj,s=this.rixt,c=this.rjxt,y=this.wixri,a=this.wjxrj,r=u,w=o.velocity,b=o.angularVelocity?o.angularVelocity:r,N=o.force,g=o.tau?o.tau:r,m=d.velocity,x=d.angularVelocity?d.angularVelocity:r,j=d.force,v=d.tau?d.tau:r,A=(this.relVel,this.relForce,o.invMass),C=d.invMass,O=(this.invIi,this.invIj,this.t),h=t,k=l;i.cross(O,s),p.cross(O,c),b.cross(i,y),x.cross(p,a),o.invInertiaWorld&&o.invInertiaWorld.vmult(g,h),d.invInertiaWorld&&d.invInertiaWorld.vmult(v,k);var q=0,z=m.dot(O)-w.dot(O)+a.dot(O)-y.dot(O),B=j.dot(O)*C-N.dot(O)*A+c.dot(k)-s.dot(h),D=-q*f-z*n-e*B;return D},n.prototype.computeC=function(){{var e=this.bi,f=this.bj,n=this.rixt,o=this.rjxt,d=e.invMass,i=f.invMass,t=d+i+this.eps;this.invIi,this.invIj}return e.invInertiaWorld&&e.invInertiaWorld.vmult(n,this.biInvInertiaTimesRixt),f.invInertiaWorld&&f.invInertiaWorld.vmult(o,this.bjInvInertiaTimesRjxt),t+=this.biInvInertiaTimesRixt.dot(n),t+=this.bjInvInertiaTimesRjxt.dot(o)};var p=new d;n.prototype.computeGWlambda=function(){var e=this.bi,f=this.bj,n=0,o=p;return f.vlambda.vsub(e.vlambda,o),n+=o.dot(this.t),e.wlambda&&(n-=e.wlambda.dot(this.rixt)),f.wlambda&&(n+=f.wlambda.dot(this.rjxt)),n};var s=new d;n.prototype.addToWlambda=function(e){var f=this.bi,n=this.bj,o=(this.rixt,this.rjxt,f.invMass),d=n.invMass,i=this.t,t=s,l=f.wlambda,u=n.wlambda;i.mult(o*e,t),f.vlambda.vsub(t,f.vlambda),i.mult(d*e,t),n.vlambda.vadd(t,n.vlambda),l&&(this.biInvInertiaTimesRixt.mult(e,t),l.vsub(t,l)),u&&(this.bjInvInertiaTimesRjxt.mult(e,t),u.vadd(t,u))}},{"../math/Mat3":21,"../math/Vec3":23,"./Equation":15}],17:[function(e,f){function n(e,f){i.call(this,e,f,-1e6,1e6),this.ni=new o,this.nj=new o,this.nixnj=new o,this.njxni=new o,this.invIi=new d,this.invIj=new d,this.relVel=new o,this.relForce=new o}f.exports=n;var o=e("../math/Vec3"),d=e("../math/Mat3"),i=e("./Equation");n.prototype=new i,n.prototype.constructor=n,n.prototype.computeB=function(e){{var f=this.a,n=this.b,d=this.bi,i=this.bj,t=this.ni,l=this.nj,u=this.nixnj,p=this.njxni,s=(d.velocity,d.angularVelocity?d.angularVelocity:new o),c=(d.force,d.tau?d.tau:new o,i.velocity,i.angularVelocity?i.angularVelocity:new o);i.force,i.tau?i.tau:new o,d.invMass,i.invMass,this.invIi,this.invIj}t.cross(l,u),l.cross(t,p);var y=-t.dot(l),a=p.dot(s)+u.dot(c),r=0,w=-y*f-a*n-e*r;return w},n.prototype.computeC=function(){var e=this.bi,f=this.bj,n=this.nixnj,o=this.njxni,d=(e.invMass,f.invMass,this.eps);return d+=e.invInertiaWorld.vmult(o).dot(o),d+=f.invInertiaWorld.vmult(n).dot(n)};new o;n.prototype.computeGWlambda=function(){var e=this.bi,f=this.bj,n=0;return e.wlambda&&(n+=e.wlambda.dot(this.njxni)),f.wlambda&&(n+=f.wlambda.dot(this.nixnj)),n},n.prototype.addToWlambda=function(e){{var f=this.bi,n=this.bj,o=this.nixnj;this.njxni,f.invMass,n.invMass}if(f.wlambda){var d=f.invInertiaWorld;f.wlambda.vsub(d.vmult(o).mult(e),f.wlambda)}if(n.wlambda){var d=n.invInertiaWorld;n.wlambda.vadd(d.vmult(o).mult(e),n.wlambda)}}},{"../math/Mat3":21,"../math/Vec3":23,"./Equation":15}],18:[function(e,f){function n(e,f,n){n=n||1e6,i.call(this,e,f,-n,n),this.axisA=new o,this.axisB=new o,this.invIi=new d,this.invIj=new d,this.targetVelocity=0}f.exports=n;var o=e("../math/Vec3"),d=e("../math/Mat3"),i=e("./Equation");n.prototype=new i,n.prototype.constructor=n,n.prototype.computeB=function(e){var f=this.a,n=this.b,d=this.bi,i=this.bj,t=this.axisA,l=this.axisB,u=(d.velocity,d.angularVelocity?d.angularVelocity:new o),p=(d.force,d.tau?d.tau:new o,i.velocity,i.angularVelocity?i.angularVelocity:new o),s=(i.force,i.tau?i.tau:new o,d.invMass,i.invMass,0),c=t.dot(u)+l.dot(p)+this.targetVelocity,y=0,a=-s*f-c*n-e*y;return a},n.prototype.computeC=function(){var e=this.bi,f=this.bj,n=this.axisA,o=this.axisB,d=(e.invMass,f.invMass,this.eps);return d+=e.invInertiaWorld.vmult(n).dot(o),d+=f.invInertiaWorld.vmult(o).dot(o)};new o;n.prototype.computeGWlambda=function(){var e=this.bi,f=this.bj,n=this.axisA,o=this.axisB,d=0;return e.wlambda&&(d+=e.wlambda.dot(n)),f.wlambda&&(d+=f.wlambda.dot(o)),d},n.prototype.addToWlambda=function(e){{var f=this.bi,n=this.bj,o=this.axisA,d=this.axisB;f.invMass,n.invMass}if(f.wlambda){var i=f.invInertiaWorld;f.wlambda.vsub(i.vmult(o).mult(e),f.wlambda)}if(n.wlambda){var i=n.invInertiaWorld;n.wlambda.vadd(i.vmult(d).mult(e),n.wlambda)}}},{"../math/Mat3":21,"../math/Vec3":23,"./Equation":15}],19:[function(e,f){function n(e,f,n,o){this.id=-1,this.materials=[e,f],this.friction=void 0!==n?Number(n):.3,this.restitution=void 0!==o?Number(o):.3,this.contactEquationStiffness=1e7,this.contactEquationRegularizationTime=3,this.frictionEquationStiffness=1e7,this.frictionEquationRegularizationTime=3}f.exports=n},{}],20:[function(e,f){function n(e){this.name=e,this.id=-1}f.exports=n},{}],21:[function(e,f){function n(e){this.elements=e?e:[0,0,0,0,0,0,0,0,0]}f.exports=n;var o=e("./Vec3");n.prototype.identity=function(){this.elements[0]=1,this.elements[1]=0,this.elements[2]=0,this.elements[3]=0,this.elements[4]=1,this.elements[5]=0,this.elements[6]=0,this.elements[7]=0,this.elements[8]=1},n.prototype.setZero=function(){var e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e[8]=0},n.prototype.setTrace=function(e){var f=this.elements;f[0]=e.x,f[4]=e.y,f[8]=e.z},n.prototype.getTrace=function(e){var e=e||new o,f=this.elements;e.x=f[0],e.y=f[4],e.z=f[8]},n.prototype.vmult=function(e,f){f=f||new o;var n=this.elements,d=e.x,i=e.y,t=e.z;return f.x=n[0]*d+n[1]*i+n[2]*t,f.y=n[3]*d+n[4]*i+n[5]*t,f.z=n[6]*d+n[7]*i+n[8]*t,f},n.prototype.smult=function(e){for(var f=0;f<this.elements.length;f++)this.elements[f]*=e},n.prototype.mmult=function(e,f){for(var o=f||new n,d=0;3>d;d++)for(var i=0;3>i;i++){for(var t=0,l=0;3>l;l++)t+=e.elements[d+3*l]*this.elements[l+3*i];o.elements[d+3*i]=t}return o},n.prototype.scale=function(e,f){f=f||new n;for(var o=this.elements,d=f.elements,i=0;3!==i;i++)d[3*i+0]=e.x*o[3*i+0],d[3*i+1]=e.y*o[3*i+1],d[3*i+2]=e.z*o[3*i+2];return f},n.prototype.solve=function(e,f){f=f||new o;for(var n=3,d=4,i=[],t=0;n*d>t;t++)i.push(0);var t,l;for(t=0;3>t;t++)for(l=0;3>l;l++)i[t+d*l]=this.elements[t+3*l];i[3]=e.x,i[7]=e.y,i[11]=e.z;var u,p,s=3,c=s,y=4;do{if(t=c-s,0===i[t+d*t])for(l=t+1;c>l;l++)if(0!==i[t+d*l]){u=y;do p=y-u,i[p+d*t]+=i[p+d*l];while(--u);break}if(0!==i[t+d*t])for(l=t+1;c>l;l++){var a=i[t+d*l]/i[t+d*t];u=y;do p=y-u,i[p+d*l]=t>=p?0:i[p+d*l]-i[p+d*t]*a;while(--u)}}while(--s);if(f.z=i[2*d+3]/i[2*d+2],f.y=(i[1*d+3]-i[1*d+2]*f.z)/i[1*d+1],f.x=(i[0*d+3]-i[0*d+2]*f.z-i[0*d+1]*f.y)/i[0*d+0],isNaN(f.x)||isNaN(f.y)||isNaN(f.z)||1/0===f.x||1/0===f.y||1/0===f.z)throw"Could not solve equation! Got x=["+f.toString()+"], b=["+e.toString()+"], A=["+this.toString()+"]";return f},n.prototype.e=function(e,f,n){return void 0===n?this.elements[f+3*e]:void(this.elements[f+3*e]=n)},n.prototype.copy=function(e){e=e||new n;for(var f=0;f<this.elements.length;f++)e.elements[f]=this.elements[f];return e},n.prototype.toString=function(){for(var e="",f=",",n=0;9>n;n++)e+=this.elements[n]+f;return e},n.prototype.reverse=function(e){e=e||new n;for(var f=3,o=6,d=[],i=0;f*o>i;i++)d.push(0);var i,t;for(i=0;3>i;i++)for(t=0;3>t;t++)d[i+o*t]=this.elements[i+3*t];d[3]=1,d[9]=0,d[15]=0,d[4]=0,d[10]=1,d[16]=0,d[5]=0,d[11]=0,d[17]=1;var l,u,p=3,s=p,c=o;do{if(i=s-p,0===d[i+o*i])for(t=i+1;s>t;t++)if(0!==d[i+o*t]){l=c;do u=c-l,d[u+o*i]+=d[u+o*t];while(--l);break}if(0!==d[i+o*i])for(t=i+1;s>t;t++){var y=d[i+o*t]/d[i+o*i];l=c;do u=c-l,d[u+o*t]=i>=u?0:d[u+o*t]-d[u+o*i]*y;while(--l)}}while(--p);i=2;do{t=i-1;do{var y=d[i+o*t]/d[i+o*i];l=o;do u=o-l,d[u+o*t]=d[u+o*t]-d[u+o*i]*y;while(--l)}while(t--)}while(--i);i=2;do{var y=1/d[i+o*i];l=o;do u=o-l,d[u+o*i]=d[u+o*i]*y;while(--l)}while(i--);i=2;do{t=2;do{if(u=d[f+t+o*i],isNaN(u)||1/0===u)throw"Could not reverse! A=["+this.toString()+"]";e.e(i,t,u)}while(t--)}while(i--);return e},n.prototype.setRotationFromQuaternion=function(e){var f=e.x,n=e.y,o=e.z,d=e.w,i=f+f,t=n+n,l=o+o,u=f*i,p=f*t,s=f*l,c=n*t,y=n*l,a=o*l,r=d*i,w=d*t,b=d*l,N=this.elements;return N[0]=1-(c+a),N[1]=p-b,N[2]=s+w,N[3]=p+b,N[4]=1-(u+a),N[5]=y-r,N[6]=s-w,N[7]=y+r,N[8]=1-(u+c),this},n.prototype.transpose=function(e){e=e||new n;for(var f=e.elements,o=this.elements,d=0;3!==d;d++)for(var i=0;3!==i;i++)f[3*d+i]=o[3*i+d];return e}},{"./Vec3":23}],22:[function(e,f){function n(e,f,n,o){this.x=void 0!==e?e:0,this.y=void 0!==f?f:0,this.z=void 0!==n?n:0,this.w=void 0!==o?o:1}f.exports=n;var o=e("./Vec3");n.prototype.set=function(e,f,n,o){this.x=e,this.y=f,this.z=n,this.w=o},n.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},n.prototype.setFromAxisAngle=function(e,f){var n=Math.sin(.5*f);this.x=e.x*n,this.y=e.y*n,this.z=e.z*n,this.w=Math.cos(.5*f)},n.prototype.toAxisAngle=function(e){e=e||new o,this.normalize();var f=2*Math.acos(this.w),n=Math.sqrt(1-this.w*this.w);return.001>n?(e.x=this.x,e.y=this.y,e.z=this.z):(e.x=this.x/n,e.y=this.y/n,e.z=this.z/n),[e,f]};var d=new o,i=new o;n.prototype.setFromVectors=function(e,f){if(e.isAntiparallelTo(f)){var n=d,o=i;e.tangents(n,o),this.setFromAxisAngle(n,Math.PI)}else{var t=e.cross(f);this.x=t.x,this.y=t.y,this.z=t.z,this.w=Math.sqrt(Math.pow(e.norm(),2)*Math.pow(f.norm(),2))+e.dot(f),this.normalize()}};var t=new o,l=new o,u=new o;n.prototype.mult=function(e,f){f=f||new n;var o=this.w,d=t,i=l,p=u;return d.set(this.x,this.y,this.z),i.set(e.x,e.y,e.z),f.w=o*e.w-d.dot(i),d.cross(i,p),f.x=o*i.x+e.w*d.x+p.x,f.y=o*i.y+e.w*d.y+p.y,f.z=o*i.z+e.w*d.z+p.z,f},n.prototype.inverse=function(e){var f=this.x,o=this.y,d=this.z,i=this.w;e=e||new n,this.conjugate(e);var t=1/(f*f+o*o+d*d+i*i);return e.x*=t,e.y*=t,e.z*=t,e.w*=t,e},n.prototype.conjugate=function(e){return e=e||new n,e.x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e},n.prototype.normalize=function(){var e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(e=1/e,this.x*=e,this.y*=e,this.z*=e,this.w*=e)},n.prototype.normalizeFast=function(){var e=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=e,this.y*=e,this.z*=e,this.w*=e)},n.prototype.vmult=function(e,f){f=f||new o;var n=e.x,d=e.y,i=e.z,t=this.x,l=this.y,u=this.z,p=this.w,s=p*n+l*i-u*d,c=p*d+u*n-t*i,y=p*i+t*d-l*n,a=-t*n-l*d-u*i;return f.x=s*p+a*-t+c*-u-y*-l,f.y=c*p+a*-l+y*-t-s*-u,f.z=y*p+a*-u+s*-l-c*-t,f},n.prototype.copy=function(e){e.x=this.x,e.y=this.y,e.z=this.z,e.w=this.w},n.prototype.toEuler=function(e,f){f=f||"YZX";var n,o,d,i=this.x,t=this.y,l=this.z,u=this.w;switch(f){case"YZX":var p=i*t+l*u;if(p>.499&&(n=2*Math.atan2(i,u),o=Math.PI/2,d=0),-.499>p&&(n=-2*Math.atan2(i,u),o=-Math.PI/2,d=0),isNaN(n)){var s=i*i,c=t*t,y=l*l;n=Math.atan2(2*t*u-2*i*l,1-2*c-2*y),o=Math.asin(2*p),d=Math.atan2(2*i*u-2*t*l,1-2*s-2*y)}break;default:throw new Error("Euler order "+f+" not supported yet.")}e.y=n,e.z=o,e.x=d},n.prototype.setFromEuler=function(e,f,n,o){o=o||"XYZ";var d=Math.cos(e/2),i=Math.cos(f/2),t=Math.cos(n/2),l=Math.sin(e/2),u=Math.sin(f/2),p=Math.sin(n/2);return"XYZ"===o?(this.x=l*i*t+d*u*p,this.y=d*u*t-l*i*p,this.z=d*i*p+l*u*t,this.w=d*i*t-l*u*p):"YXZ"===o?(this.x=l*i*t+d*u*p,this.y=d*u*t-l*i*p,this.z=d*i*p-l*u*t,this.w=d*i*t+l*u*p):"ZXY"===o?(this.x=l*i*t-d*u*p,this.y=d*u*t+l*i*p,this.z=d*i*p+l*u*t,this.w=d*i*t-l*u*p):"ZYX"===o?(this.x=l*i*t-d*u*p,this.y=d*u*t+l*i*p,this.z=d*i*p-l*u*t,this.w=d*i*t+l*u*p):"YZX"===o?(this.x=l*i*t+d*u*p,this.y=d*u*t+l*i*p,this.z=d*i*p-l*u*t,this.w=d*i*t-l*u*p):"XZY"===o&&(this.x=l*i*t-d*u*p,this.y=d*u*t-l*i*p,this.z=d*i*p+l*u*t,this.w=d*i*t+l*u*p),this
}},{"./Vec3":23}],23:[function(e,f){function n(e,f,n){this.x=e||0,this.y=f||0,this.z=n||0}f.exports=n;var o=e("./Mat3");n.prototype.cross=function(e,f){var o=e.x,d=e.y,i=e.z,t=this.x,l=this.y,u=this.z;return f=f||new n,f.x=l*i-u*d,f.y=u*o-t*i,f.z=t*d-l*o,f},n.prototype.set=function(e,f,n){return this.x=e,this.y=f,this.z=n,this},n.prototype.vadd=function(e,f){return f?(f.x=e.x+this.x,f.y=e.y+this.y,f.z=e.z+this.z,void 0):new n(this.x+e.x,this.y+e.y,this.z+e.z)},n.prototype.vsub=function(e,f){return f?(f.x=this.x-e.x,f.y=this.y-e.y,f.z=this.z-e.z,void 0):new n(this.x-e.x,this.y-e.y,this.z-e.z)},n.prototype.crossmat=function(){return new o([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},n.prototype.normalize=function(){var e=this.x,f=this.y,n=this.z,o=Math.sqrt(e*e+f*f+n*n);if(o>0){var d=1/o;this.x*=d,this.y*=d,this.z*=d}else this.x=0,this.y=0,this.z=0;return o},n.prototype.unit=function(e){e=e||new n;var f=this.x,o=this.y,d=this.z,i=Math.sqrt(f*f+o*o+d*d);return i>0?(i=1/i,e.x=f*i,e.y=o*i,e.z=d*i):(e.x=1,e.y=0,e.z=0),e},n.prototype.norm=function(){var e=this.x,f=this.y,n=this.z;return Math.sqrt(e*e+f*f+n*n)},n.prototype.norm2=function(){return this.dot(this)},n.prototype.distanceTo=function(e){var f=this.x,n=this.y,o=this.z,d=e.x,i=e.y,t=e.z;return Math.sqrt((d-f)*(d-f)+(i-n)*(i-n)+(t-o)*(t-o))},n.prototype.mult=function(e,f){f=f||new n;var o=this.x,d=this.y,i=this.z;return f.x=e*o,f.y=e*d,f.z=e*i,f},n.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},n.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},n.prototype.negate=function(e){return e=e||new n,e.x=-this.x,e.y=-this.y,e.z=-this.z,e};var d=new n,i=new n;n.prototype.tangents=function(e,f){var n=this.norm();if(n>0){var o=d,t=1/n;o.set(this.x*t,this.y*t,this.z*t);var l=i;Math.abs(o.x)<.9?(l.set(1,0,0),o.cross(l,e)):(l.set(0,1,0),o.cross(l,e)),o.cross(e,f)}else e.set(1,0,0).normalize(),f.set(0,1,0).normalize()},n.prototype.toString=function(){return this.x+","+this.y+","+this.z},n.prototype.copy=function(e){return e=e||new n,e.x=this.x,e.y=this.y,e.z=this.z,e},n.prototype.lerp=function(e,f,n){var o=this.x,d=this.y,i=this.z;n.x=o+(e.x-o)*f,n.y=d+(e.y-d)*f,n.z=i+(e.z-i)*f},n.prototype.almostEquals=function(e,f){return void 0===f&&(f=1e-6),Math.abs(this.x-e.x)>f||Math.abs(this.y-e.y)>f||Math.abs(this.z-e.z)>f?!1:!0},n.prototype.almostZero=function(e){return void 0===e&&(e=1e-6),Math.abs(this.x)>e||Math.abs(this.y)>e||Math.abs(this.z)>e?!1:!0};var t=new n;n.prototype.isAntiparallelTo=function(e,f){return this.negate(t),t.almostEquals(e,f)}},{"./Mat3":21}],24:[function(e,f){function n(e){o.apply(this),this.type=e,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new d,this.collisionFilterGroup=1,this.collisionFilterMask=1,this.collisionResponse=!0}f.exports=n;var o=e("../utils/EventTarget"),d=e("../math/Vec3");n.prototype=new o,n.DYNAMIC=1,n.STATIC=2,n.KINEMATIC=4},{"../math/Vec3":23,"../utils/EventTarget":38}],25:[function(e,f){function n(e,f){if("number"!=typeof e)throw new Error("Argument 1 (mass) must be a number.");if("undefined"!=typeof f&&!(f instanceof i))throw new Error("Argument 2 (material) must be an instance of Material.");d.call(this,"particle"),this.position=new o,this.initPosition=new o,this.velocity=new o,this.initVelocity=new o,this.force=new o,this.mass=e,this.invMass=e>0?1/e:0,this.material=f,this.linearDamping=.01,this.motionstate=0>=e?d.STATIC:d.DYNAMIC,this.allowSleep=!0,this.sleepState=0,this.sleepSpeedLimit=.1,this.sleepTimeLimit=1,this.timeLastSleepy=0}f.exports=n;var o=(e("../shapes/Shape"),e("../math/Vec3")),d=(e("../math/Quaternion"),e("./Body")),i=e("../material/Material");n.prototype=new d,n.prototype.constructor=n,n.prototype.isAwake=function(){return 0===this.sleepState},n.prototype.isSleepy=function(){return 1===this.sleepState},n.prototype.isSleeping=function(){return 2===this.sleepState},n.prototype.wakeUp=function(){var e=this.sleepState;this.sleepState=0,2===e&&this.dispatchEvent({type:"wakeup"})},n.prototype.sleep=function(){this.sleepState=2},n.prototype.sleepTick=function(e){if(this.allowSleep){var f=this.sleepState,n=this.velocity.norm2(),o=Math.pow(this.sleepSpeedLimit,2);0===f&&o>n?(this.sleepState=1,this.timeLastSleepy=e,this.dispatchEvent({type:"sleepy"})):1===f&&n>o?this.wakeUp():1===f&&e-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleepState=2,this.dispatchEvent({type:"sleep"}))}}},{"../material/Material":20,"../math/Quaternion":22,"../math/Vec3":23,"../shapes/Shape":33,"./Body":24}],26:[function(e,f){function n(e,f,n){if("number"!=typeof e)throw new Error("Argument 1 (mass) must be a number.");if("undefined"!=typeof n&&!(n instanceof l))throw new Error("Argument 3 (material) must be an instance of Material.");t.call(this,e,n);this.tau=new o,this.quaternion=new i,this.initQuaternion=new i,this.angularVelocity=new o,this.initAngularVelocity=new o,this.shape=f,this.inertia=new o,f.calculateLocalInertia(e,this.inertia),this.inertiaWorld=new o,this.inertia.copy(this.inertiaWorld),this.invInertia=new o(this.inertia.x>0?1/this.inertia.x:0,this.inertia.y>0?1/this.inertia.y:0,this.inertia.z>0?1/this.inertia.z:0),this.invInertiaWorld=new d,this.angularDamping=.01,this.aabbmin=new o,this.aabbmax=new o,this.aabbNeedsUpdate=!0,this.wlambda=new o,this.updateInertiaWorld(!0)}f.exports=n;var o=(e("../shapes/Shape"),e("../math/Vec3")),d=e("../math/Mat3"),i=e("../math/Quaternion"),t=e("./Particle"),l=e("../material/Material");n.prototype=new t(0),n.prototype.constructor=n,n.prototype.computeAABB=function(){this.shape.calculateWorldAABB(this.position,this.quaternion,this.aabbmin,this.aabbmax),this.aabbNeedsUpdate=!1};{var u=new d,p=new d;new d}n.prototype.updateInertiaWorld=function(e){var f=this.invInertia;if(f.x!=f.y||f.y!=f.z||e){var n=u,o=p;n.setRotationFromQuaternion(this.quaternion),n.transpose(o),n.scale(f,n),n.mmult(o,this.invInertiaWorld)}else;};var s=new o,c=new o;n.prototype.applyForce=function(e,f){var n=s;f.vsub(this.position,n);var o=c;n.cross(e,o),this.force.vadd(e,this.force),this.tau.vadd(o,this.tau)};var y=new o,a=new o,r=new o;n.prototype.applyImpulse=function(e,f){var n=y;f.vsub(this.position,n);var o=a;e.copy(o),o.mult(this.invMass,o),this.velocity.vadd(o,this.velocity);var d=r;n.cross(e,d),this.invInertiaWorld.vmult(d,d),this.angularVelocity.vadd(d,this.angularVelocity)}},{"../material/Material":20,"../math/Mat3":21,"../math/Quaternion":22,"../math/Vec3":23,"../shapes/Shape":33,"./Particle":25}],27:[function(e,f){function n(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}f.exports=n;{var o=(e("../shapes/Shape"),e("../math/Vec3"));e("../math/Quaternion"),e("./Particle"),e("../material/Material")}n.prototype.add=function(e){this.particles.push(e),this.neighbors.length<this.particles.length&&this.neighbors.push([])},n.prototype.remove=function(e){var f=this.particles.indexOf(e);-1!==f&&(this.particles.splice(f,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var d=new o;n.prototype.getNeighbors=function(e,f){for(var n=this.particles.length,o=e.id,i=this.smoothingRadius*this.smoothingRadius,t=d,l=0;l!==n;l++){var u=this.particles[l];u.position.vsub(e.position,t),o!==u.id&&t.norm2()<i&&f.push(u)}};var i=new o,t=new o,l=new o,u=new o,p=new o,s=new o;n.prototype.update=function(){for(var e=this.particles.length,f=i,n=this.speedOfSound,o=this.eps,d=0;d!==e;d++){var c=this.particles[d],y=this.neighbors[d];y.length=0,this.getNeighbors(c,y),y.push(this.particles[d]);for(var a=y.length,r=0,w=0;w!==a;w++){c.position.vsub(y[w].position,f);var b=f.norm(),N=this.w(b);r+=y[w].mass*N}this.densities[d]=r,this.pressures[d]=n*n*(this.densities[d]-this.density)}for(var g=t,m=l,x=u,j=p,v=s,d=0;d!==e;d++){var A=this.particles[d];g.set(0,0,0),m.set(0,0,0);for(var C,O,y=this.neighbors[d],a=y.length,w=0;w!==a;w++){var h=y[w];A.position.vsub(h.position,j);var k=j.norm();C=-h.mass*(this.pressures[d]/(this.densities[d]*this.densities[d]+o)+this.pressures[w]/(this.densities[w]*this.densities[w]+o)),this.gradw(j,x),x.mult(C,x),g.vadd(x,g),h.velocity.vsub(A.velocity,v),v.mult(1/(1e-4+this.densities[d]*this.densities[w])*this.viscosity*h.mass,v),O=this.nablaw(k),v.mult(O,v),m.vadd(v,m)}m.mult(A.mass,m),g.mult(A.mass,g),A.force.vadd(m,A.force),A.force.vadd(g,A.force)}},n.prototype.w=function(e){var f=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(f,9))*Math.pow(f*f-e*e,3)},n.prototype.gradw=function(e,f){var n=e.norm(),o=this.smoothingRadius;e.mult(945/(32*Math.PI*Math.pow(o,9))*Math.pow(o*o-n*n,2),f)},n.prototype.nablaw=function(e){var f=this.smoothingRadius,n=945/(32*Math.PI*Math.pow(f,9))*(f*f-e*e)*(7*e*e-3*f*f);return n}},{"../material/Material":20,"../math/Quaternion":22,"../math/Vec3":23,"../shapes/Shape":33,"./Particle":25}],28:[function(e,f){function n(e){o.call(this),this.type=o.types.BOX,this.halfExtents=e,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation()}f.exports=n;var o=e("./Shape"),d=e("../math/Vec3"),i=e("./ConvexPolyhedron");n.prototype=new o,n.prototype.constructor=n,n.prototype.updateConvexPolyhedronRepresentation=function(){var e=this.halfExtents.x,f=this.halfExtents.y,n=this.halfExtents.z,o=d,t=new i([new o(-e,-f,-n),new o(e,-f,-n),new o(e,f,-n),new o(-e,f,-n),new o(-e,-f,n),new o(e,-f,n),new o(e,f,n),new o(-e,f,n)],[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]],[new o(0,0,-1),new o(0,0,1),new o(0,-1,0),new o(0,1,0),new o(-1,0,0),new o(1,0,0)]);this.convexPolyhedronRepresentation=t},n.prototype.calculateLocalInertia=function(e,f){return f=f||new d,n.calculateInertia(this.halfExtents,e,f),f},n.calculateInertia=function(e,f,n){var o=e;n.x=1/12*f*(2*o.y*2*o.y+2*o.z*2*o.z),n.y=1/12*f*(2*o.x*2*o.x+2*o.z*2*o.z),n.z=1/12*f*(2*o.y*2*o.y+2*o.x*2*o.x)},n.prototype.getSideNormals=function(e,f){var n=e,o=this.halfExtents;if(n[0].set(o.x,0,0),n[1].set(0,o.y,0),n[2].set(0,0,o.z),n[3].set(-o.x,0,0),n[4].set(0,-o.y,0),n[5].set(0,0,-o.z),void 0!==f)for(var d=0;d!==n.length;d++)f.vmult(n[d],n[d]);return n},n.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},n.prototype.computeBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm(),this.boundingSphereRadiusNeedsUpdate=!1};{var t=new d;new d}n.prototype.forEachWorldCorner=function(e,f,n){for(var o=this.halfExtents,d=[[o.x,o.y,o.z],[-o.x,o.y,o.z],[-o.x,-o.y,o.z],[-o.x,-o.y,-o.z],[o.x,-o.y,-o.z],[o.x,o.y,-o.z],[-o.x,o.y,-o.z],[o.x,-o.y,o.z]],i=0;i<d.length;i++)t.set(d[i][0],d[i][1],d[i][2]),f.vmult(t,t),e.vadd(t,t),n(t.x,t.y,t.z)},n.prototype.calculateWorldAABB=function(e,f,n,o){n.set(1/0,1/0,1/0),o.set(-1/0,-1/0,-1/0),this.forEachWorldCorner(e,f,function(e,f,d){e>o.x&&(o.x=e),f>o.y&&(o.y=f),d>o.z&&(o.z=d),e<n.x&&(n.x=e),f<n.y&&(n.y=f),d<n.z&&(n.z=d)})}},{"../math/Vec3":23,"./ConvexPolyhedron":30,"./Shape":33}],29:[function(e,f){function n(){o.call(this),this.type=o.types.COMPOUND,this.childShapes=[],this.childOffsets=[],this.childOrientations=[]}f.exports=n;var o=e("./Shape"),d=e("../math/Vec3"),i=e("../shapes/Box"),t=(e("../math/Mat3"),e("../math/Quaternion"));n.prototype=new o,n.prototype.constructor=n,n.prototype.addChild=function(e,f,n){f=f||new d,n=n||new t,this.childShapes.push(e),this.childOffsets.push(f),this.childOrientations.push(n)},n.prototype.volume=function(){for(var e=0,f=this.childShapes.length,n=0;n!==f;n++)e+=this.childShapes[n].volume();return e};var l=new d,u=new d,p=new d,s=new t;n.prototype.calculateLocalInertia=function(e,f){f=f||new d;var n=l,o=u,t=p,c=s;return this.calculateWorldAABB(t,c,n,o),i.calculateInertia(new d((o.x-n.x)/2,(o.y-n.y)/2,(o.z-n.z)/2),e,f),f},n.prototype.computeBoundingSphereRadius=function(){for(var e=0,f=0;f<this.childShapes.length;f++){var n=this.childShapes[f];n.boundingSphereRadiusNeedsUpdate&&n.computeBoundingSphereRadius();var o=this.childOffsets[f].norm()+n.boundingSphereRadius;o>e&&(e=o)}this.boundingSphereRadius=e,this.boundingSphereRadiusNeedsUpdate=!1};var c=new d,y=new d,a=new d,r=new t;n.prototype.calculateWorldAABB=function(e,f,n,o){var d=this.childShapes.length;n.set(1/0,1/0,1/0),o.set(-1/0,-1/0,-1/0);for(var i=0;i!==d;i++)this.childOffsets[i].copy(a),f.vmult(a,a),e.vadd(a,a),f.mult(this.childOrientations[i],r),this.childShapes[i].calculateWorldAABB(a,r,y,c),y.x<n.x&&(n.x=y.x),y.y<n.y&&(n.y=y.y),y.z<n.z&&(n.z=y.z),c.x>o.x&&(o.x=c.x),c.y>o.y&&(o.y=c.y),c.z>o.z&&(o.z=c.z)}},{"../math/Mat3":21,"../math/Quaternion":22,"../math/Vec3":23,"../shapes/Box":28,"./Shape":33}],30:[function(e,f){function n(e,f){o.call(this),this.type=o.types.CONVEXPOLYHEDRON,this.vertices=e||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=f||[],this.faceNormals=[];for(var n=0;n<this.faces.length;n++){for(var i=0;i<this.faces[n].length;i++)if(!this.vertices[this.faces[n][i]])throw new Error("Vertex "+this.faces[n][i]+" not found!");var t=new d;this.getFaceNormal(n,t),t.negate(t),this.faceNormals.push(t);var l=this.vertices[this.faces[n][0]];if(t.dot(l)<0){console.warn("Face normal "+n+" ("+t.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.");for(var i=0;i<this.faces[n].length;i++)console.warn("Vertex "+this.faces[n][i]+": ("+this.vertices[f[n][i]].toString()+")")}}this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[];for(var u=this.vertices.length,p=0;u>p;p++){var s=this.vertices[p];if(!(s instanceof d))throw"Argument 1 must be instance of Vec3";this.uniqueEdges.push(s)}for(var n=0;n<this.faces.length;n++)for(var c=this.faces[n].length,y=c,i=0;y>i;i++){var a=(i+1)%c,r=new d;this.vertices[this.faces[n][i]].vsub(this.vertices[this.faces[n][a]],r),r.normalize();for(var w=!1,s=0;s<this.uniqueEdges.length;s++)if(this.uniqueEdges[s].almostEquals(r)||this.uniqueEdges[s].almostEquals(r)){w=!0;break}w||this.uniqueEdges.push(r),r&&(r.face1=n)}}f.exports=n;var o=e("./Shape"),d=e("../math/Vec3"),i=e("../math/Quaternion");n.prototype=new o,n.prototype.constructor=n;var t=new d,l=new d;n.computeNormal=function(e,f,n,o){f.vsub(e,l),n.vsub(f,t),t.cross(l,o),o.isZero()||o.normalize()},n.prototype.getFaceNormal=function(e,f){var o=this.faces[e],d=this.vertices[o[0]],i=this.vertices[o[1]],t=this.vertices[o[2]];return n.computeNormal(d,i,t,f)};var u=new d;n.prototype.clipAgainstHull=function(e,f,n,o,t,l,p,s,c){var y=u;if(!(e instanceof d))throw new Error("posA must be Vec3");if(!(f instanceof i))throw new Error("quatA must be Quaternion");for(var a=-1,r=-1/0,w=0;w<n.faces.length;w++){n.faceNormals[w].copy(y),t.vmult(y,y);var b=y.dot(l);b>r&&(r=b,a=w)}for(var N=[],g=n.faces[a],m=g.length,x=0;m>x;x++){var j=n.vertices[g[x]],v=new d;j.copy(v),t.vmult(v,v),o.vadd(v,v),N.push(v)}a>=0&&this.clipFaceAgainstHull(l,e,f,N,p,s,c)};var p=new d,s=new d,c=new d,y=new d,a=new d,r=new d;n.prototype.findSeparatingAxis=function(e,f,n,o,d,i){for(var t=p,l=s,u=c,w=y,b=a,N=r,g=1/0,m=this,x=0,j=m.faces.length,v=0;j>v;v++){m.faceNormals[v].copy(t),n.vmult(t,t);var A=m.testSepAxis(t,e,f,n,o,d);if(A===!1)return!1;g>A&&(g=A,t.copy(i))}for(var C=e.faces.length,v=0;C>v;v++){e.faceNormals[v].copy(l),d.vmult(l,l),x++;var A=m.testSepAxis(l,e,f,n,o,d);if(A===!1)return!1;g>A&&(g=A,l.copy(i))}for(var O=0,h=0;h<m.uniqueEdges.length;h++){m.uniqueEdges[h].copy(w),n.vmult(w,w);for(var k=0;k<e.uniqueEdges.length;k++)if(e.uniqueEdges[k].copy(b),d.vmult(b,b),w.cross(b,N),O++,!N.almostZero()){N.normalize();var q=m.testSepAxis(N,e,f,n,o,d);if(q===!1)return!1;g>q&&(g=q,N.copy(i))}}return o.vsub(f,u),u.dot(i)>0&&i.negate(i),!0},n.prototype.testSepAxis=function(e,f,o,d,i,t){var l=[],u=[],p=this;n.project(p,e,o,d,l),n.project(f,e,i,t,u);var s=l[0],c=l[1],y=u[0],a=u[1];if(a>s||c>y)return!1;var r=s-a,w=y-c,b=w>r?r:w;return b},n.prototype.calculateLocalInertia=function(e,f){this.computeAABB();var n=this.aabbmax.x-this.aabbmin.x,o=this.aabbmax.y-this.aabbmin.y,d=this.aabbmax.z-this.aabbmin.z;f.x=1/12*e*(2*o*2*o+2*d*2*d),f.y=1/12*e*(2*n*2*n+2*d*2*d),f.z=1/12*e*(2*o*2*o+2*n*2*n)},n.prototype.getPlaneConstantOfFace=function(e){var f=this.faces[e],n=this.faceNormals[e],o=this.vertices[f[0]],d=-n.dot(o);return d};var w=new d,b=new d,N=new d,g=new d,m=new d,x=new d,j=new d,v=new d;n.prototype.clipFaceAgainstHull=function(e,f,n,o,i,t,l){if(!(e instanceof d))throw new Error("sep normal must be vector");if(!(o instanceof Array))throw new Error("world verts must be array");var u=w,p=b,s=N,c=g,y=m,a=x,r=j,A=v;i=Number(i),t=Number(t);for(var C=this,O=[],h=o,k=O,q=-1,z=1/0,B=0;B<C.faces.length;B++){C.faceNormals[B].copy(u),n.vmult(u,u);var D=u.dot(e);z>D&&(z=D,q=B)}if(0>q)return void console.log("--- did not find any closest face... ---");var E=C.faces[q];E.connectedFaces=[];for(var F=0;F<C.faces.length;F++)for(var G=0;G<C.faces[F].length;G++)-1!==E.indexOf(C.faces[F][G])&&F!==q&&-1===E.connectedFaces.indexOf(F)&&E.connectedFaces.push(F);for(var H=(h.length,E.length),I=0;H>I;I++){var J=C.vertices[E[I]],K=C.vertices[E[(I+1)%H]];J.vsub(K,p),p.copy(s),n.vmult(s,s),f.vadd(s,s),this.faceNormals[q].copy(c),n.vmult(c,c),f.vadd(c,c),s.cross(c,y),y.negate(y),J.copy(a),n.vmult(a,a),f.vadd(a,a);var L,M=(-a.dot(y),E.connectedFaces[I]);this.faceNormals[M].copy(r);var P=this.getPlaneConstantOfFace(M);r.copy(A),n.vmult(A,A);var L=P-A.dot(f);for(this.clipFaceAgainstPlane(h,k,A,L);h.length;)h.shift();for(;k.length;)h.push(k.shift())}this.faceNormals[q].copy(r);var P=this.getPlaneConstantOfFace(q);r.copy(A),n.vmult(A,A);for(var L=P-A.dot(f),F=0;F<h.length;F++){var Q=A.dot(h[F])+L;if(i>=Q&&(console.log("clamped: depth="+Q+" to minDist="+(i+"")),Q=i),t>=Q){var R=h[F];if(0>=Q){var S={point:R,normal:A,depth:Q};l.push(S)}}}},n.prototype.clipFaceAgainstPlane=function(e,f,n,o){if(!(n instanceof d))throw new Error("planeNormal must be Vec3, "+n+" given");if(!(e instanceof Array))throw new Error("invertices must be Array, "+e+" given");if(!(f instanceof Array))throw new Error("outvertices must be Array, "+f+" given");var i,t,l=e.length;if(2>l)return f;var u=e[e.length-1],p=e[0];i=n.dot(u)+o;for(var s=0;l>s;s++){if(p=e[s],t=n.dot(p)+o,0>i)if(0>t){var c=new d;p.copy(c),f.push(c)}else{var c=new d;u.lerp(p,i/(i-t),c),f.push(c)}else if(0>t){var c=new d;u.lerp(p,i/(i-t),c),f.push(c),f.push(p)}u=p,i=t}return f},n.prototype.computeWorldVertices=function(e,f){for(var n=this.vertices.length;this.worldVertices.length<n;)this.worldVertices.push(new d);for(var o=this.vertices,i=this.worldVertices,t=0;t!==n;t++)f.vmult(o[t],i[t]),e.vadd(i[t],i[t]);this.worldVerticesNeedsUpdate=!1};new d;n.prototype.computeAABB=function(){var e=this.vertices.length,f=this.aabbmin,n=this.aabbmax,o=this.vertices;f.set(1/0,1/0,1/0),n.set(-1/0,-1/0,-1/0);for(var d=0;e>d;d++){var i=o[d];i.x<f.x?f.x=i.x:i.x>n.x&&(n.x=i.x),i.y<f.y?f.y=i.y:i.y>n.y&&(n.y=i.y),i.z<f.z?f.z=i.z:i.z>n.z&&(n.z=i.z)}},n.prototype.computeWorldFaceNormals=function(e){for(var f=this.faceNormals.length;this.worldFaceNormals.length<f;)this.worldFaceNormals.push(new d);for(var n=this.faceNormals,o=this.worldFaceNormals,i=0;i!==f;i++)e.vmult(n[i],o[i]);this.worldFaceNormalsNeedsUpdate=!1},n.prototype.computeBoundingSphereRadius=function(){for(var e=0,f=this.vertices,n=0,o=f.length;n!==o;n++){var d=f[n].norm2();d>e&&(e=d)}this.boundingSphereRadius=Math.sqrt(e),this.boundingSphereRadiusNeedsUpdate=!1};var A=new d;n.prototype.calculateWorldAABB=function(e,f,n,o){for(var d,i,t,l,u,p,s=this.vertices.length,c=this.vertices,y=0;s>y;y++){c[y].copy(A),f.vmult(A,A),e.vadd(A,A);var a=A;a.x<d||void 0===d?d=a.x:(a.x>l||void 0===l)&&(l=a.x),a.y<i||void 0===i?i=a.y:(a.y>u||void 0===u)&&(u=a.y),a.z<t||void 0===t?t=a.z:(a.z>p||void 0===p)&&(p=a.z)}n.set(d,i,t),o.set(l,u,p)},n.prototype.volume=function(){return this.boundingSphereRadiusNeedsUpdate&&this.computeBoundingSphereRadius(),4*Math.PI*this.boundingSphereRadius/3},n.prototype.getAveragePointLocal=function(e){e=e||new d;for(var f=this.vertices.length,n=this.vertices,o=0;f>o;o++)e.vadd(n[o],e);return e.mult(1/f,e),e},n.prototype.transformAllPoints=function(e,f){var n=this.vertices.length,o=this.vertices;if(f){for(var d=0;n>d;d++){var i=o[d];f.vmult(i,i)}for(var d=0;d<this.faceNormals.length;d++){var i=this.faceNormals[d];f.vmult(i,i)}}if(e)for(var d=0;n>d;d++){var i=o[d];i.vadd(e,i)}};var C=new d,O=new d,h=new d;n.prototype.pointIsInside=function(e){var f=this.vertices.length,n=this.vertices,o=this.faces,d=this.faceNormals,i=null,t=this.faces.length,l=C;this.getAveragePointLocal(l);for(var u=0;t>u;u++){var f=(this.faces[u].length,d[u]),p=n[o[u][0]],s=O;e.vsub(p,s);var c=f.dot(s),y=h;l.vsub(p,y);var a=f.dot(y);if(0>c&&a>0||c>0&&0>a)return!1}return i?1:-1};var k=new d;n.project=function(e,f,n,o,d){for(var i=e.vertices.length,t=k,l=null,u=null,p=e.vertices,s=0;i>s;s++){p[s].copy(t),o.vmult(t,t),t.vadd(n,t);var c=t.dot(f);(null===l||c>l)&&(l=c),(null===u||u>c)&&(u=c)}if(u>l){var y=u;u=l,l=y}d[0]=l,d[1]=u}},{"../math/Quaternion":22,"../math/Vec3":23,"./Shape":33}],31:[function(e,f){function n(e,f,n,t){var l=t,u=[],p=[],s=[],c=[],y=[],a=Math.cos,r=Math.sin;u.push(new d(f*a(0),f*r(0),.5*-n)),c.push(0),u.push(new d(e*a(0),e*r(0),.5*n)),y.push(1);for(var w=0;l>w;w++){var b=2*Math.PI/l*(w+1),N=2*Math.PI/l*(w+.5);l-1>w?(u.push(new d(f*a(b),f*r(b),.5*-n)),c.push(2*w+2),u.push(new d(e*a(b),e*r(b),.5*n)),y.push(2*w+3),p.push(new d(a(N),r(N),0)),s.push([2*w+2,2*w+3,2*w+1,2*w])):(s.push([0,1,2*w+1,2*w]),p.push(new d(a(N),r(N),0)))}s.push(y),p.push(new d(0,0,1));for(var g=[],w=0;w<c.length;w++)g.push(c[c.length-w-1]);s.push(g),p.push(new d(0,0,-1)),this.type=o.types.CONVEXPOLYHEDRON,i.call(this,u,s,p)}f.exports=n;var o=e("./Shape"),d=e("../math/Vec3"),i=(e("../math/Quaternion"),e("./ConvexPolyhedron"));n.prototype=new i},{"../math/Quaternion":22,"../math/Vec3":23,"./ConvexPolyhedron":30,"./Shape":33}],32:[function(e,f){function n(){o.call(this),this.type=o.types.PLANE,this.worldNormal=new d,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=1/0}f.exports=n;var o=e("./Shape"),d=e("../math/Vec3");n.prototype=new o,n.prototype.constructor=n,n.prototype.computeWorldNormal=function(e){var f=this.worldNormal;f.set(0,0,1),e.vmult(f,f),this.worldNormalNeedsUpdate=!1},n.prototype.calculateLocalInertia=function(e,f){return f=f||new d},n.prototype.volume=function(){return 1/0};var i=new d;n.prototype.calculateWorldAABB=function(e,f,n,o){i.set(0,0,1),f.vmult(i,i),n.set(-1/0,-1/0,-1/0),o.set(1/0,1/0,1/0),1===i.x&&(o.x=e.x),1===i.y&&(o.y=e.y),1===i.z&&(o.z=e.z),-1===i.x&&(n.x=e.x),-1===i.y&&(n.y=e.y),-1===i.z&&(n.z=e.z)}},{"../math/Vec3":23,"./Shape":33}],33:[function(e,f){function n(){this.type=0,this.aabbmin=new o,this.aabbmax=new o,this.boundingSphereRadius=0,this.boundingSphereRadiusNeedsUpdate=!0}f.exports=n;{var n=e("./Shape"),o=e("../math/Vec3");e("../math/Quaternion"),e("../objects/Particle"),e("../material/Material")}n.prototype.constructor=n,n.prototype.computeBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},n.prototype.getBoundingSphereRadius=function(){return this.boundingSphereRadiusNeedsUpdate&&this.computeBoundingSphereRadius(),this.boundingSphereRadius},n.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},n.prototype.calculateLocalInertia=function(){throw"calculateLocalInertia() not implemented for shape type "+this.type};var d=new o,i=new o;n.prototype.calculateTransformedInertia=function(e,f,n){n=n||new o;var t=d,l=i;return this.calculateLocalInertia(e,t),f.vmult(t,l),n.x=Math.abs(l.x),n.y=Math.abs(l.y),n.z=Math.abs(l.z),n},n.calculateLocalAABB=function(){throw new Error(".calculateLocalAABB is not implemented for this Shape yet!")},n.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16}},{"../material/Material":20,"../math/Quaternion":22,"../math/Vec3":23,"../objects/Particle":25,"./Shape":33}],34:[function(e,f){function n(e){o.call(this),this.radius=void 0!==e?Number(e):1,this.type=o.types.SPHERE}f.exports=n;var o=e("./Shape"),d=e("../math/Vec3");n.prototype=new o,n.prototype.constructor=n,n.prototype.calculateLocalInertia=function(e,f){f=f||new d;var n=2*e*this.radius*this.radius/5;return f.x=n,f.y=n,f.z=n,f},n.prototype.volume=function(){return 4*Math.PI*this.radius/3},n.prototype.computeBoundingSphereRadius=function(){this.boundingSphereRadiusNeedsUpdate=!1,this.boundingSphereRadius=this.radius},n.prototype.calculateWorldAABB=function(e,f,n,o){for(var d=this.radius,i=["x","y","z"],t=0;t<i.length;t++){var l=i[t];n[l]=e[l]-d,o[l]=e[l]+d}}},{"../math/Vec3":23,"./Shape":33}],35:[function(e,f){function n(){o.call(this),this.iterations=10,this.tolerance=0}f.exports=n;var o=(e("../math/Vec3"),e("../math/Quaternion"),e("./Solver"));n.prototype=new o;var d=[],i=[],t=[];n.prototype.solve=function(e,f){var n,o,l,u,p,s,c=(this.d,this.k,0),y=this.iterations,a=this.tolerance*this.tolerance,r=(this.a,this.b),w=this.equations,b=w.length,N=f.bodies,g=N.length,m=e,x=i,j=t,v=d;x.length=0,j.length=0,v.length=0;for(var A=0;A!==b;A++){var C=w[A];C.spookParamsNeedsUpdate&&(C.updateSpookParams(m),C.spookParamsNeedsUpdate=!1),v[A]=0,j[A]=C.computeB(m),x[A]=1/C.computeC()}if(0!==b){for(var A=0;A!==g;A++){var r=N[A],O=r.vlambda,h=r.wlambda;O.set(0,0,0),h&&h.set(0,0,0)}for(c=0;c!==y;c++){u=0;for(var k=0;k!==b;k++){var C=w[k];n=j[k],o=x[k],s=v[k],p=C.computeGWlambda(),l=o*(n-p-C.eps*s),s+l<C.minForce?l=C.minForce-s:s+l>C.maxForce&&(l=C.maxForce-s),v[k]+=l,u+=l>0?l:-l,C.addToWlambda(l)}if(a>u*u)break}for(var A=0;A!==g;A++){var r=N[A],q=r.velocity,z=r.angularVelocity;q.vadd(r.vlambda,q),z&&z.vadd(r.wlambda,z)}}return c}},{"../math/Quaternion":22,"../math/Vec3":23,"./Solver":36}],36:[function(e,f){function n(){this.equations=[]}f.exports=n,n.prototype.solve=function(){return 0},n.prototype.addEquation=function(e){this.equations.push(e)},n.prototype.removeEquation=function(e){var f=this.equations,n=f.indexOf(e);-1!==n&&f.splice(n,1)},n.prototype.removeAllEquations=function(){this.equations.length=0}},{}],37:[function(e,f){function n(e){o.call(this),this.subsolver=e}f.exports=n;var o=(e("../math/Vec3"),e("../math/Quaternion"),e("./Solver")),d=e("../objects/Body");n.prototype=new o;var i=[],t=[],l=[],u={bodies:null};n.prototype.solve=function(e,f){function n(e){for(var f=e.length,n=0;n!==f;n++){var o=e[n];if(!(o.visited||o.body.motionstate&C))return o}return!1}function o(e,f){var o=[];for(o.push(e),e.visited=!0,f(e);o.length;)for(var d,i=o.pop();d=n(i.children);)d.visited=!0,f(d),o.push(d)}function p(e){k.push(e.body);for(var f=e.eqs.length,n=0;n!==f;n++){var o=e.eqs[n];-1===h.indexOf(o)&&h.push(o)}}for(var s=i,c=f.bodies,y=this.equations,a=y.length,r=c.length,w=this.subsolver,b=s.length;b!==r;b++)s.push({body:c[b],children:[],eqs:[],visited:!1});for(var b=0;b!==r;b++){var N=s[b];N.body=c[b],N.children.length=0,N.eqs.length=0,N.visited=!1}for(var g=0;g!==a;g++){var m=y[g],b=c.indexOf(m.bi),x=c.indexOf(m.bj),j=s[b],v=s[x];j.children.push(v),j.eqs.push(m),v.children.push(j),v.eqs.push(m)}for(var A,C=d.STATIC,O=0,h=t,k=l,q=u;A=n(s);){h.length=0,k.length=0,o(A,p);for(var z=h.length,b=0;b!==z;b++)w.addEquation(h[b]);q.bodies=k;{w.solve(e,q)}w.removeAllEquations(),O++}return O}},{"../math/Quaternion":22,"../math/Vec3":23,"../objects/Body":24,"./Solver":36}],38:[function(e,f){var n=function(){};f.exports=n,n.prototype={constructor:n,addEventListener:function(e,f){void 0===this._listeners&&(this._listeners={});var n=this._listeners;return void 0===n[e]&&(n[e]=[]),-1===n[e].indexOf(f)&&n[e].push(f),this},hasEventListener:function(e,f){if(void 0===this._listeners)return!1;var n=this._listeners;return void 0!==n[e]&&-1!==n[e].indexOf(f)?!0:!1},removeEventListener:function(e,f){if(void 0===this._listeners)return this;var n=this._listeners,o=n[e].indexOf(f);return-1!==o&&n[e].splice(o,1),this},dispatchEvent:function(e){if(void 0===this._listeners)return this;var f=this._listeners,n=f[e.type];if(void 0!==n){e.target=this;for(var o=0,d=n.length;d>o;o++)n[o].call(this,e)}return this}}},{}],39:[function(e,f){function n(){this.objects=[],this.type=Object}f.exports=n,n.prototype.release=function(){for(var e=arguments.length,f=0;f!==e;f++)this.objects.push(arguments[f])},n.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},n.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")}},{}],40:[function(e,f){function n(){d.call(this),this.type=o}f.exports=n;var o=e("../math/Vec3"),d=e("./Pool");n.prototype=new d,n.prototype.constructObject=function(){return new o}},{"../math/Vec3":23,"./Pool":39}],41:[function(e,f){function n(){this.contactReduction=!1,this.contactPointPool=[],this.v3pool=new l}function o(e,f,n){for(var o=null,d=e.length,i=0;i!==d;i++){var t=e[i],l=c;e[(i+1)%d].vsub(t,l);var u=y;l.cross(f,u);var p=a;n.vsub(t,p);var s=u.dot(p);if(!(null===o||s>0&&o===!0||0>=s&&o===!1))return!1;null===o&&(o=s>0)}return!0}f.exports=n;var d=e("../shapes/Shape"),i=e("../math/Vec3"),t=e("../math/Quaternion"),l=(e("../solver/Solver"),e("../utils/Vec3Pool")),u=e("../equations/ContactEquation");n.prototype.swapResult=function(e){var f;f=e.ri,e.ri=e.rj,e.rj=f,e.ni.negate(e.ni),f=e.bi,e.bi=e.bj,e.bj=f},n.prototype.reduceContacts=function(){},n.prototype.makeResult=function(e,f){if(this.contactPointPool.length){var n=this.contactPointPool.pop();return n.bi=e,n.bj=f,n}return new u(e,f)},n.prototype.getContacts=function(e,f,n,o,d){this.contactPointPool=d;for(var i=0,t=e.length;i!==t;i++){var l=e[i],u=f[i];this.narrowphase(o,l.shape,u.shape,l.position,u.position,l.quaternion,u.quaternion,l,u)}},n.prototype.narrowphase=function(e,f,n,o,i,t,l,u,p){var s=!1,c=d.types,y=c.SPHERE,a=c.PLANE,r=c.BOX,w=c.COMPOUND,b=c.CONVEXPOLYHEDRON;if(f&&n){if(f.type>n.type){var N;N=n,n=f,f=N,N=i,i=o,o=N,N=l,l=t,t=N,N=p,p=u,u=N,s=!0}}else if(f&&!n){var N;N=n,n=f,f=N,N=i,i=o,o=N,N=l,l=t,t=N,N=p,p=u,u=N,s=!0}if(f&&n){if(f.type===y)switch(n.type){case y:this.sphereSphere(e,f,n,o,i,t,l,u,p);break;case a:this.spherePlane(e,f,n,o,i,t,l,u,p);break;case r:this.sphereBox(e,f,n,o,i,t,l,u,p);break;case w:this.recurseCompound(e,f,n,o,i,t,l,u,p);break;case b:this.sphereConvex(e,f,n,o,i,t,l,u,p);break;default:console.warn("Collision between Shape.types.SPHERE and "+n.type+" not implemented yet.")}else if(f.type===c.PLANE)switch(n.type){case c.PLANE:throw new Error("Plane-plane collision... wait, you did WHAT?");case c.BOX:this.planeBox(e,f,n,o,i,t,l,u,p);break;case c.COMPOUND:this.recurseCompound(e,f,n,o,i,t,l,u,p);break;case c.CONVEXPOLYHEDRON:this.planeConvex(e,f,n,o,i,t,l,u,p);break;default:console.warn("Collision between Shape.types.PLANE and "+n.type+" not implemented yet.")}else if(f.type===c.BOX)switch(n.type){case c.BOX:this.narrowphase(e,f.convexPolyhedronRepresentation,n.convexPolyhedronRepresentation,o,i,t,l,u,p);break;case c.COMPOUND:this.recurseCompound(e,f,n,o,i,t,l,u,p);break;case c.CONVEXPOLYHEDRON:this.narrowphase(e,f.convexPolyhedronRepresentation,n,o,i,t,l,u,p);break;default:console.warn("Collision between Shape.types.BOX and "+n.type+" not implemented yet.")}else if(f.type===c.COMPOUND)switch(n.type){case c.COMPOUND:this.recurseCompound(e,f,n,o,i,t,l,u,p);break;case c.CONVEXPOLYHEDRON:var g=[];this.recurseCompound(g,n,f,i,o,l,t,p,u);for(var m=0;m!==g.length;m++)this.swapResult(g[m]),e.push(g[m]);break;default:console.warn("Collision between Shape.types.COMPOUND and "+n.type+" not implemented yet.")}else if(f.type===c.CONVEXPOLYHEDRON)switch(n.type){case c.CONVEXPOLYHEDRON:this.convexConvex(e,f,n,o,i,t,l,u,p);break;default:console.warn("Collision between Shape.types.CONVEXPOLYHEDRON and "+n.type+" not implemented yet.")}}else switch(n.type){case c.PLANE:this.particlePlane(e,f,n,o,i,t,l,u,p);break;case c.SPHERE:this.particleSphere(e,f,n,o,i,t,l,u,p);break;case c.BOX:this.particleConvex(e,f,n.convexPolyhedronRepresentation,o,i,t,l,u,p);break;case c.CONVEXPOLYHEDRON:this.particleConvex(e,f,n,o,i,t,l,u,p);
break;case c.COMPOUND:this.recurseCompound(e,f,n,o,i,t,l,u,p);break;default:console.warn("Collision between Particle and "+n.type+" not implemented yet.")}for(var x=0,j=e.length;s&&x!==j;x++)this.swapResult(e[x])},n.prototype.sphereSphere=function(e,f,n,o,d,i,t,l,u){var p=this.makeResult(l,u);u.position.vsub(o,p.ni),p.ni.normalize(),p.ni.copy(p.ri),p.ni.copy(p.rj),p.ri.mult(f.radius,p.ri),p.rj.mult(-n.radius,p.rj),e.push(p)};var p=new i,s=new i;n.prototype.spherePlane=function(e,f,n,o,d,i,t,l,u){var c=this.makeResult(l,u);c.ni.set(0,0,1),t.vmult(c.ni,c.ni),c.ni.negate(c.ni),c.ni.normalize(),c.ni.mult(f.radius,c.ri),o.vsub(d,p),c.ni.mult(c.ni.dot(p),s),p.vsub(s,c.rj),s.norm2()<=f.radius*f.radius&&e.push(c)};var c=new i,y=new i,a=new i,r=new i,w=new i,b=new i,N=new i,g=[new i,new i,new i,new i,new i,new i],m=new i,x=new i,j=new i,v=new i;n.prototype.sphereBox=function(e,f,n,o,d,i,t,l,u){var p=this.v3pool,s=g;o.vsub(d,r),n.getSideNormals(s,t);for(var c=f.radius,y=!1,a=x,A=j,C=v,O=null,h=0,k=0,q=0,z=null,B=0,D=s.length;B!==D&&y===!1;B++){var E=w;s[B].copy(E);var F=E.norm();E.normalize();var G=r.dot(E);if(F+c>G&&G>0){var H=b,I=N;s[(B+1)%3].copy(H),s[(B+2)%3].copy(I);var J=H.norm(),K=I.norm();H.normalize(),I.normalize();var L=r.dot(H),M=r.dot(I);if(J>L&&L>-J&&K>M&&M>-K){var P=Math.abs(G-F-c);(null===z||z>P)&&(z=P,k=L,q=M,O=F,E.copy(a),H.copy(A),I.copy(C),h++)}}}if(h){y=!0;var Q=this.makeResult(l,u);a.mult(-c,Q.ri),a.copy(Q.ni),Q.ni.negate(Q.ni),a.mult(O,a),A.mult(k,A),a.vadd(A,a),C.mult(q,C),a.vadd(C,Q.rj),e.push(Q)}for(var R=p.get(),S=m,T=0;2!==T&&!y;T++)for(var U=0;2!==U&&!y;U++)for(var V=0;2!==V&&!y;V++)if(R.set(0,0,0),T?R.vadd(s[0],R):R.vsub(s[0],R),U?R.vadd(s[1],R):R.vsub(s[1],R),V?R.vadd(s[2],R):R.vsub(s[2],R),d.vadd(R,S),S.vsub(o,S),S.norm2()<c*c){y=!0;var Q=this.makeResult(l,u);S.copy(Q.ri),Q.ri.normalize(),Q.ri.copy(Q.ni),Q.ri.mult(c,Q.ri),R.copy(Q.rj),e.push(Q)}p.release(R),R=null;for(var W=p.get(),X=p.get(),Q=p.get(),Y=p.get(),P=p.get(),Z=s.length,T=0;T!==Z&&!y;T++)for(var U=0;U!==Z&&!y;U++)if(T%3!==U%3){s[U].cross(s[T],W),W.normalize(),s[T].vadd(s[U],X),o.copy(Q),Q.vsub(X,Q),Q.vsub(d,Q);var $=Q.dot(W);W.mult($,Y);for(var V=0;V===T%3||V===U%3;)V++;o.copy(P),P.vsub(Y,P),P.vsub(X,P),P.vsub(d,P);var _=Math.abs($),ef=P.norm();if(_<s[V].norm()&&c>ef){y=!0;var ff=this.makeResult(l,u);X.vadd(Y,ff.rj),ff.rj.copy(ff.rj),P.negate(ff.ni),ff.ni.normalize(),ff.rj.copy(ff.ri),ff.ri.vadd(d,ff.ri),ff.ri.vsub(o,ff.ri),ff.ri.normalize(),ff.ri.mult(c,ff.ri),e.push(ff)}}p.release(W,X,Q,Y,P)};var A=new i,C=new i,O=new i,h=new i,k=new i,q=new i,z=new i,B=new i,D=new i,E=new i;n.prototype.sphereConvex=function(e,f,n,d,i,t,l,u,p){var s=this.v3pool;d.vsub(i,A);for(var c=n.faceNormals,y=n.faces,a=n.vertices,r=f.radius,w=0;w!==a.length;w++){var b=a[w],N=k;l.vmult(b,N),i.vadd(N,N);var g=h;if(N.vsub(d,g),g.norm2()<r*r){x=!0;var m=this.makeResult(u,p);return g.copy(m.ri),m.ri.normalize(),m.ri.copy(m.ni),m.ri.mult(r,m.ri),N.vsub(i,m.rj),void e.push(m)}}for(var x=!1,w=0,j=y.length;w!==j&&x===!1;w++){var v=c[w],F=y[w],G=q;l.vmult(v,G);var H=z;l.vmult(a[F[0]],H),H.vadd(i,H);var I=B;G.mult(-r,I),d.vadd(I,I);var J=D;I.vsub(H,J);var K=J.dot(G),L=E;if(d.vsub(H,L),0>K&&L.dot(G)>0){for(var M=[],P=0,Q=F.length;P!==Q;P++){var R=s.get();l.vmult(a[F[P]],R),i.vadd(R,R),M.push(R)}if(o(M,G,d)){x=!0;var m=this.makeResult(u,p);G.mult(-r,m.ri),G.negate(m.ni);var S=s.get();G.mult(-K,S);var T=s.get();G.mult(-r,T),d.vsub(i,m.rj),m.rj.vadd(T,m.rj),m.rj.vadd(S,m.rj),s.release(S),s.release(T),e.push(m);for(var P=0,U=M.length;P!==U;P++)s.release(M[P]);return}for(var P=0;P!==F.length;P++){var V=s.get(),W=s.get();l.vmult(a[F[(P+1)%F.length]],V),l.vmult(a[F[(P+2)%F.length]],W),i.vadd(V,V),i.vadd(W,W);var X=C;W.vsub(V,X);var Y=O;X.unit(Y);var Z=s.get(),$=s.get();d.vsub(V,$);var _=$.dot(Y);Y.mult(_,Z),Z.vadd(V,Z);var ef=s.get();if(Z.vsub(d,ef),_>0&&_*_<X.norm2()&&ef.norm2()<r*r){var m=this.makeResult(u,p);Z.vsub(i,m.rj),Z.vsub(d,m.ni),m.ni.normalize(),m.ni.mult(r,m.ri),e.push(m);for(var P=0,U=M.length;P!==U;P++)s.release(M[P]);return s.release(V),s.release(W),s.release(Z),s.release(ef),void s.release($)}s.release(V),s.release(W),s.release(Z),s.release(ef),s.release($)}for(var P=0,U=M.length;P!==U;P++)s.release(M[P])}}};new i,new i;n.prototype.planeBox=function(e,f,n,o,d,i,t,l,u){this.planeConvex(e,f,n.convexPolyhedronRepresentation,o,d,i,t,l,u)};var F=[],G=[];n.prototype.recurseCompound=function(e,f,n,o,d,l,u,p,s){for(var c=F,y=G,a=0,r=0,w=n.childShapes.length;r!==w;r++){var b=[],N=y.pop()||new t,g=c.pop()||new i;u.mult(n.childOrientations[r],N),N.normalize(),u.vmult(n.childOffsets[r],g),d.vadd(g,g),this.narrowphase(b,f,n.childShapes[r],o,g,l,N,p,s),y.push(N);var m=g;f||(a+=b.length);for(var x=0;x!==b.length;x++)u.vmult(n.childOffsets[r],m),b[x].rj.vadd(m,b[x].rj),e.push(b[x]);c.push(g)}};var H=new i,I=new i,J=new i,K=new i;n.prototype.planeConvex=function(e,f,n,o,d,i,t,l,u){var p=H,s=I;s.set(0,0,1),i.vmult(s,s);for(var c=J,y=0;y!==n.vertices.length;y++){n.vertices[y].copy(p),t.vmult(p,p),d.vadd(p,p),p.vsub(o,c);var a=s.dot(c);if(0>=a){var r=K;s.mult(s.dot(p),r),p.vsub(r,r);var w=this.makeResult(l,u);s.copy(w.ni),r.copy(w.ri),p.vsub(d,w.rj),e.push(w)}}};var L=new i,M=new i;n.prototype.convexConvex=function(e,f,n,o,d,i,t,l,u){var p=L;if(f.findSeparatingAxis(n,o,i,d,t,p)){var s=[],c=M;f.clipAgainstHull(o,i,n,d,t,p,-100,100,s);for(var y=0;y!==s.length;y++){var a=this.makeResult(l,u);p.negate(a.ni),s[y].normal.negate(c),c.mult(s[y].depth,c),s[y].point.vadd(c,a.ri),s[y].point.copy(a.rj),a.rj.vsub(d,a.rj),a.ri.vsub(o,a.ri),e.push(a)}}};var P=new i,Q=new i,R=new i;n.prototype.particlePlane=function(e,f,n,o,d,i,t,l,u){var p=P;p.set(0,0,1),u.quaternion.vmult(p,p);var s=Q;o.vsub(u.position,s);var c=p.dot(s);if(0>=c){var y=this.makeResult(l,u);p.copy(y.ni),y.ni.negate(y.ni),y.ri.set(0,0,0);var a=R;p.mult(p.dot(o),a),o.vsub(a,a),a.copy(y.rj),e.push(y)}};var S=new i;n.prototype.particleSphere=function(e,f,n,o,d,i,t,l,u){var p=S;p.set(0,0,1),o.vsub(d,p);var s=p.norm2();if(s<=n.radius*n.radius){var c=this.makeResult(l,u);p.normalize(),p.copy(c.rj),c.rj.mult(n.radius,c.rj),p.copy(c.ni),c.ni.negate(c.ni),c.ri.set(0,0,0),e.push(c)}};var T=new t,U=new i,V=(new i,new i),W=new i,X=new i;n.prototype.particleConvex=function(e,f,n,o,d,i,t,l,u){var p=-1,s=V,c=X,y=null,a=0,r=U;if(o.copy(r),r.vsub(d,r),t.conjugate(T),T.vmult(r,r),n.pointIsInside(r)){n.worldVerticesNeedsUpdate&&n.computeWorldVertices(d,t),n.worldFaceNormalsNeedsUpdate&&n.computeWorldFaceNormals(t);for(var w=0,b=n.faces.length;w!==b;w++){var N=[n.worldVertices[n.faces[w][0]]],g=n.worldFaceNormals[w];o.vsub(N[0],W);var m=-g.dot(W);(null===y||Math.abs(m)<Math.abs(y))&&(y=m,p=w,g.copy(s),a++)}if(-1!==p){var x=this.makeResult(l,u);s.mult(y,c),c.vadd(o,c),c.vsub(d,c),c.copy(x.rj),s.negate(x.ni),x.ri.set(0,0,0),e.push(x)}else console.warn("Point found inside convex, but did not find penetrating face!")}}},{"../equations/ContactEquation":14,"../math/Quaternion":22,"../math/Vec3":23,"../shapes/Shape":33,"../solver/Solver":36,"../utils/Vec3Pool":40}],42:[function(e,f){function n(){p.apply(this),this.allowSleep=!1,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=0,this.quatNormalizeFast=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.last_dt=this.default_dt,this.nextId=0,this.gravity=new d,this.broadphase=null,this.bodies=[],this.solver=new t,this.constraints=[],this.contactgen=new u,this.collisionMatrix=new s,this.collisionMatrixPrevious=new s,this.materials=[],this.contactmaterials=[],this.mats2cmat=[],this.defaultMaterial=new c("default"),this.defaultContactMaterial=new y(this.defaultMaterial,this.defaultMaterial,.3,0),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,nearphase:0},this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null}}f.exports=n;var o=e("../shapes/Shape"),d=e("../math/Vec3"),i=e("../math/Quaternion"),t=e("../solver/GSSolver"),l=(e("../utils/Vec3Pool"),e("../equations/ContactEquation"),e("../equations/FrictionEquation")),u=e("./ContactGenerator"),p=e("../utils/EventTarget"),s=e("../collision/ArrayCollisionMatrix"),c=e("../material/Material"),y=e("../material/ContactMaterial"),a=e("../objects/RigidBody"),r=e("../objects/Body");if(n.prototype=new p,n.prototype.getContactMaterial=function(e,f){if(e instanceof c&&f instanceof c){var n=e.id,o=f.id;if(o>n){var d=n;n=o,o=d}return this.contactmaterials[this.mats2cmat[n+o*this.materials.length]]}},n.prototype.numObjects=function(){return this.bodies.length},n.prototype.collisionMatrixTick=function(){var e=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=e,this.collisionMatrix.reset()},n.prototype.add=function(e){e.id=this.id(),e.index=this.bodies.length,this.bodies.push(e),e.world=this,e.position.copy(e.initPosition),e.velocity.copy(e.initVelocity),e.timeLastSleepy=this.time,e instanceof a&&(e.angularVelocity.copy(e.initAngularVelocity),e.quaternion.copy(e.initQuaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=e,this.dispatchEvent(this.addBodyEvent)},n.prototype.addConstraint=function(e){this.constraints.push(e),e.id=this.id()},n.prototype.removeConstraint=function(e){var f=this.constraints.indexOf(e);-1!==f&&this.constraints.splice(f,1)},n.prototype.id=function(){return this.nextId++},n.prototype.remove=function(e){e.world=null;var f=this.numObjects()-1,n=this.bodies;n.splice(e.index,1);for(var o=e.index;f>o;o++)n[o].index=o;this.collisionMatrix.setNumObjects(f),this.removeBodyEvent.body=e,this.dispatchEvent(this.removeBodyEvent)},n.prototype.addMaterial=function(e){if(-1===e.id){var f=this.materials.length;this.materials.push(e),e.id=this.materials.length-1;for(var n=0;n!==2*f+1;n++)this.mats2cmat.push(-1)}},n.prototype.addContactMaterial=function(e){this.addMaterial(e.materials[0]),this.addMaterial(e.materials[1]);var f,n;e.materials[0].id>e.materials[1].id?(f=e.materials[0].id,n=e.materials[1].id):(n=e.materials[0].id,f=e.materials[1].id),this.contactmaterials.push(e),e.id=this.contactmaterials.length-1,this.mats2cmat[f+this.materials.length*n]=e.id},"undefined"==typeof performance&&(performance={}),!performance.now){var w=Date.now();performance.timing&&performance.timing.navigationStart&&(w=performance.timing.navigationStart),performance.now=function(){return Date.now()-w}}var b={type:"postStep"},N={type:"preStep"},g={type:"collide","with":null,contact:null},m=[],x=[],j=[],v=[],A=new d,C=(new d,new d,new d,new d,new d,new d,new d,new d,new i,new i),O=new i,h=new d;n.prototype.step=function(e){if(!(0>=e||isNaN(e))){var f,n=this.contacts,d=j,i=v,t=this.numObjects(),u=this.bodies,p=this.solver,s=this.gravity,c=this.doProfiling,y=this.profile,a=r.DYNAMIC,w=this.constraints,k=x,q=s.norm(),z=s.x,B=s.y,D=s.z,E=0;for(c&&(f=performance.now()),void 0===e&&(e=this.last_dt||this.default_dt),E=0;E!==t;E++){var F=u[E];if(F.motionstate&a){var G=F.force,H=F.mass;G.x+=H*z,G.y+=H*B,G.z+=H*D}}for(var E=0,I=this.subsystems.length;E!==I;E++)this.subsystems[E].update();c&&(f=performance.now()),d.length=0,i.length=0,this.broadphase.collisionPairs(this,d,i),c&&(y.broadphase=performance.now()-f),this.collisionMatrixTick(),c&&(f=performance.now());var J=m,K=n.length;for(E=0;E!==K;E++)J.push(n[E]);n.length=0,this.contactgen.getContacts(d,i,this,n,J),c&&(y.nearphase=performance.now()-f),c&&(f=performance.now());var L=n.length,M=this.frictionEquations.length;for(E=0;E!==M;E++)k.push(this.frictionEquations[E]);this.frictionEquations.length=0;for(var P=0;P!==L;P++){var Q=n[P],F=Q.bi,R=Q.bj,E=u.indexOf(F),S=u.indexOf(R),T=this.getContactMaterial(F.material,R.material)||this.defaultContactMaterial,U=T.friction,V=A;V.set(R.position.x+Q.rj.x-F.position.x-Q.ri.x,R.position.y+Q.rj.y-F.position.y-Q.ri.y,R.position.z+Q.rj.z-F.position.z-Q.ri.z);var W=V.dot(Q.ni);if(0>W){if(F.collisionResponse&&R.collisionResponse&&(Q.restitution=T.restitution,Q.penetration=W,Q.stiffness=T.contactEquationStiffness,Q.regularizationTime=T.contactEquationRegularizationTime,p.addEquation(Q),U>0)){var X=U*q,Y=F.invMass+R.invMass;Y>0&&(Y=1/Y);var Z=k,$=Z.length?Z.pop():new l(F,R,X*Y),_=Z.length?Z.pop():new l(F,R,X*Y);this.frictionEquations.push($),this.frictionEquations.push(_),$.bi=_.bi=F,$.bj=_.bj=R,$.minForce=_.minForce=-X*Y,$.maxForce=_.maxForce=X*Y,Q.ri.copy($.ri),Q.rj.copy($.rj),Q.ri.copy(_.ri),Q.rj.copy(_.rj),Q.ni.tangents($.t,_.t),p.addEquation($),p.addEquation(_)}this.collisionMatrix.set(F,R,!0),this.collisionMatrix.get(F,R)!==this.collisionMatrixPrevious.get(F,R)&&(g.with=R,g.contact=Q,F.dispatchEvent(g),g.with=F,R.dispatchEvent(g),F.wakeUp(),R.wakeUp())}}c&&(y.makeContactConstraints=performance.now()-f),c&&(f=performance.now());var ef=w.length;for(E=0;E!==ef;E++){var Q=w[E];Q.update();for(var S=0,ff=Q.equations.length;S!==ff;S++){var nf=Q.equations[S];p.addEquation(nf)}}p.solve(e,this),c&&(y.solve=performance.now()-f),p.removeAllEquations();var of=Math.pow;for(E=0;E!==t;E++){var F=u[E];if(F.motionstate&a){var df=of(1-F.linearDamping,e),tf=F.velocity;tf.mult(df,tf);var lf=F.angularVelocity;if(lf){var uf=of(1-F.angularDamping,e);lf.mult(uf,lf)}}}for(this.dispatchEvent(N),E=0;E!==t;E++){var F=u[E];F.preStep&&F.preStep.call(F)}c&&(f=performance.now());var pf=C,sf=O,cf=this.stepnumber,yf=r.DYNAMIC|r.KINEMATIC,af=cf%(this.quatNormalizeSkip+1)===0,rf=this.quatNormalizeFast,wf=.5*e,bf=o.types.PLANE,Nf=o.types.CONVEXPOLYHEDRON;for(E=0;E!==t;E++){var gf=u[E],mf=gf.shape,xf=gf.force,jf=gf.tau;if(gf.motionstate&yf&&!gf.isSleeping()){var vf=gf.velocity,Af=gf.angularVelocity,Cf=gf.position,Of=gf.quaternion,hf=gf.invMass,kf=gf.invInertiaWorld;if(vf.x+=xf.x*hf*e,vf.y+=xf.y*hf*e,vf.z+=xf.z*hf*e,gf.angularVelocity&&(kf.vmult(jf,h),h.mult(e,h),h.vadd(Af,Af)),Cf.x+=vf.x*e,Cf.y+=vf.y*e,Cf.z+=vf.z*e,gf.angularVelocity&&(pf.set(Af.x,Af.y,Af.z,0),pf.mult(Of,sf),Of.x+=wf*sf.x,Of.y+=wf*sf.y,Of.z+=wf*sf.z,Of.w+=wf*sf.w,af&&(rf?Of.normalizeFast():Of.normalize())),gf.aabbmin&&(gf.aabbNeedsUpdate=!0),mf)switch(mf.type){case bf:mf.worldNormalNeedsUpdate=!0;break;case Nf:mf.worldFaceNormalsNeedsUpdate=!0,mf.worldVerticesNeedsUpdate=!0}gf.updateInertiaWorld&&gf.updateInertiaWorld()}gf.force.set(0,0,0),gf.tau&&gf.tau.set(0,0,0)}for(c&&(y.integrate=performance.now()-f),this.time+=e,this.stepnumber+=1,this.dispatchEvent(b),E=0;E!==t;E++){var F=u[E],qf=F.postStep;qf&&qf.call(F)}if(this.allowSleep)for(E=0;E!==t;E++)u[E].sleepTick(this.time)}}},{"../collision/ArrayCollisionMatrix":3,"../equations/ContactEquation":14,"../equations/FrictionEquation":16,"../material/ContactMaterial":19,"../material/Material":20,"../math/Quaternion":22,"../math/Vec3":23,"../objects/Body":24,"../objects/RigidBody":26,"../shapes/Shape":33,"../solver/GSSolver":35,"../utils/EventTarget":38,"../utils/Vec3Pool":40,"./ContactGenerator":41}]},{},[2])(2)});